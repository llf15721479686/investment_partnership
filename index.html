<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººåˆä¼™æŠ•èµ„ä»½é¢åˆ†é…ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e4e8;
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            flex: 0 0 300px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }

        .main-content {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }

        .section-title {
            color: #3498db;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.5rem;
        }

        /* è‡ªå®šä¹‰å¯¹è¯æ¡†æ ·å¼ */
        .custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .dialog-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            animation: dialogAppear 0.3s ease;
        }

        @keyframes dialogAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dialog-header {
            padding: 20px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .dialog-header h3 {
                color: #2c3e50;
                font-size: 1.3rem;
                margin: 0;
            }

        .dialog-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #7f8c8d;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

            .dialog-close:hover {
                color: #e74c3c;
            }

        .dialog-body {
            padding: 20px;
        }

        .dialog-footer {
            padding: 15px 20px;
            border-top: 1px solid #e1e4e8;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .dialog-message {
            font-size: 1.1rem;
            line-height: 1.5;
            color: #333;
        }

        .dialog-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-top: 10px;
        }

            .dialog-input:focus {
                border-color: #3498db;
                outline: none;
                box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

            .btn-primary:hover {
                background-color: #2980b9;
            }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

            .btn-success:hover {
                background-color: #27ae60;
            }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

            .btn-danger:hover {
                background-color: #c0392b;
            }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

            .btn-secondary:hover {
                background-color: #7f8c8d;
            }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

            .btn-warning:hover {
                background-color: #d68910;
            }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é¡¹ç›®åˆ—è¡¨æ ·å¼ */
        .project-selector {
            margin-bottom: 30px;
        }

        .project-list {
            list-style: none;
            margin-top: 15px;
        }

        .project-item {
            padding: 12px 15px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .project-item:hover {
                background-color: #f8f9fa;
                border-color: #3498db;
            }

            .project-item.active {
                background-color: #e3f2fd;
                border-color: #3498db;
                font-weight: 600;
            }

        .project-name {
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .project-info {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #495057;
            }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

            .form-control:focus {
                border-color: #3498db;
                outline: none;
                box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            }

        /* åˆä¼™äººè¡¨æ ¼æ ·å¼ */
        .partners-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

            .partners-table th {
                background-color: #f8f9fa;
                text-align: left;
                padding: 12px 15px;
                font-weight: 600;
                color: #495057;
                border-bottom: 2px solid #e9ecef;
            }

            .partners-table td {
                padding: 12px 15px;
                border-bottom: 1px solid #e9ecef;
            }

            .partners-table input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 1rem;
                transition: border 0.3s;
            }

                .partners-table input:focus {
                    border-color: #3498db;
                    outline: none;
                    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
                }

        .partner-row.new {
            background-color: #f8f9ff;
        }

        .partner-row.dirty {
            background-color: #fff8e1;
        }

        /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e4e8;
        }

            .action-buttons .btn {
                flex: 1;
            }

        /* ç»“æœå±•ç¤ºæ ·å¼ */
        .results-container {
            margin-top: 30px;
        }

        .total-investment {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .total-amount {
            font-size: 2.2rem;
            color: #2c3e50;
            font-weight: 700;
            margin: 10px 0;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

            .results-table th {
                background-color: #f8f9fa;
                text-align: left;
                padding: 15px;
                font-weight: 600;
                color: #495057;
                border-bottom: 2px solid #e9ecef;
            }

            .results-table td {
                padding: 15px;
                border-bottom: 1px solid #e9ecef;
            }

        .highlight {
            font-weight: 700;
            color: #2c3e50;
        }

        .share-bar-container {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .share-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }

        /* å¯è§†åŒ–å›¾è¡¨ */
        .visualization {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .chart-container {
            display: flex;
            height: 300px;
            align-items: flex-end;
            justify-content: space-around;
            margin-top: 20px;
            padding: 0 10px;
        }

        .chart-bar {
            width: 60px;
            background-color: #3498db;
            border-radius: 6px 6px 0 0;
            position: relative;
            transition: height 1s ease;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: 700;
            color: #3498db;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 40px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

            .message.success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .message.error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .message.warning {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .message.info {
                background-color: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

        /* æ“ä½œæ—¥å¿— */
        .logs-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e1e4e8;
        }

        .logs-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 10px;
        }

        .log-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e1e4e8;
            font-size: 0.9rem;
        }

            .log-item:last-child {
                border-bottom: none;
            }

        .log-time {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        /* è¾“å…¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }

        .status-saved {
            background-color: #2ecc71;
        }

        .status-unsaved {
            background-color: #f39c12;
        }

        .status-new {
            background-color: #3498db;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                flex: none;
                width: 100%;
            }

            .chart-container {
                height: 250px;
            }

            .chart-bar {
                width: 40px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* è¾“å…¥éªŒè¯é”™è¯¯æ ·å¼ */
        .input-error {
            border-color: #e74c3c !important;
            background-color: #fff5f5;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- è‡ªå®šä¹‰å¯¹è¯æ¡† -->
    <div id="customDialog" class="custom-dialog">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3 id="dialogTitle">æç¤º</h3>
                <button class="dialog-close" onclick="hideDialog()">Ã—</button>
            </div>
            <div class="dialog-body">
                <div class="dialog-message" id="dialogMessage"></div>
                <input type="text" id="dialogInput" class="dialog-input" style="display: none;" placeholder="è¯·è¾“å…¥">
            </div>
            <div class="dialog-footer">
                <button id="dialogCancel" class="btn btn-secondary" onclick="handleDialogCancel()">å–æ¶ˆ</button>
                <button id="dialogConfirm" class="btn btn-primary" onclick="handleDialogConfirm()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>å¤šäººåˆä¼™æŠ•èµ„ä»½é¢åˆ†é…ç³»ç»Ÿ</h1>
            <p class="subtitle">åŸºäºSQLiteæ•°æ®åº“çš„æŠ•èµ„ä»½é¢ç®¡ç†ä¸è®¡ç®—å·¥å…·</p>
        </header>

        <div class="app-container">
            <div class="sidebar">
                <h2 class="section-title">é¡¹ç›®åˆ—è¡¨</h2>
                <div class="project-selector">
                    <div id="projectList">
                        <p id="noProjectsMessage">æš‚æ— é¡¹ç›®ï¼Œè¯·åˆ›å»ºæ–°é¡¹ç›®</p>
                    </div>
                </div>

                <div class="new-project-form">
                    <h3 class="section-title">æ–°å»ºé¡¹ç›®</h3>
                    <div class="form-group">
                        <label for="projectName">é¡¹ç›®åç§° <span style="color: #e74c3c;">*</span></label>
                        <input type="text" id="projectName" class="form-control" placeholder="è¾“å…¥é¡¹ç›®åç§°" required>
                    </div>
                    <div class="form-group">
                        <label for="projectDescription">é¡¹ç›®æè¿°</label>
                        <textarea id="projectDescription" class="form-control" rows="3" placeholder="è¾“å…¥é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                    <button id="createProjectBtn" class="btn btn-success" style="width: 100%;">
                        <span>+ åˆ›å»ºæ–°é¡¹ç›®</span>
                    </button>
                </div>

                <div class="logs-section">
                    <h3 class="section-title">æœ€è¿‘æ“ä½œ</h3>
                    <div id="recentLogs" class="logs-list">
                        <p style="text-align: center; color: #7f8c8d;">æš‚æ— æ“ä½œè®°å½•</p>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div id="messageArea"></div>

                <div id="noProjectSelected">
                    <h2 class="section-title">æ¬¢è¿ä½¿ç”¨</h2>
                    <p>è¯·ä»å·¦ä¾§é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªé¡¹ç›®å¼€å§‹ä½¿ç”¨ã€‚</p>
                    <p>ç³»ç»ŸåŠŸèƒ½åŒ…æ‹¬ï¼š</p>
                    <ul>
                        <li>åˆ›å»ºå’Œç®¡ç†å¤šä¸ªæŠ•èµ„é¡¹ç›®</li>
                        <li>æ·»åŠ ã€ç¼–è¾‘å’Œåˆ é™¤åˆä¼™äºº</li>
                        <li>è‡ªåŠ¨è®¡ç®—æŠ•èµ„ä»½é¢æ¯”ä¾‹</li>
                        <li>å¯è§†åŒ–å±•ç¤ºä»½é¢åˆ†é…</li>
                        <li>æ•°æ®æŒä¹…åŒ–å­˜å‚¨åˆ°SQLiteæ•°æ®åº“</li>
                    </ul>
                    <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                        <h4>ä½¿ç”¨æç¤ºï¼š</h4>
                        <ol>
                            <li>ç‚¹å‡»å·¦ä¾§"æ–°å»ºé¡¹ç›®"åˆ›å»ºæ–°é¡¹ç›®</li>
                            <li>é€‰æ‹©é¡¹ç›®åå¯ä»¥æ·»åŠ åˆä¼™äºº</li>
                            <li>å¡«å†™åˆä¼™äººä¿¡æ¯åç‚¹å‡»"ä¿å­˜åˆä¼™äººä¿¡æ¯"</li>
                            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºä»½é¢åˆ†é…ç»“æœ</li>
                        </ol>
                    </div>
                </div>

                <div id="projectContent" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 class="section-title" id="currentProjectName">é¡¹ç›®åç§°</h2>
                            <div id="projectDescriptionDisplay" style="color: #7f8c8d; margin-top: 5px;"></div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="saveAllBtn" class="btn btn-primary">
                                <span>ğŸ’¾ ä¿å­˜æ‰€æœ‰æ›´æ”¹</span>
                            </button>
                            <button id="deleteProjectBtn" class="btn btn-danger">
                                <span>ğŸ—‘ï¸ åˆ é™¤é¡¹ç›®</span>
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <h3 class="section-title" style="margin-bottom: 0;">åˆä¼™äººç®¡ç†</h3>
                        <span id="saveStatus" style="font-size: 0.9rem; color: #7f8c8d;">
                            <span class="status-indicator status-saved"></span> å·²ä¿å­˜
                        </span>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <button id="addPartnerBtn" class="btn btn-success">
                            <span>+ æ·»åŠ åˆä¼™äººè¡Œ</span>
                        </button>
                        <span style="margin-left: 15px; color: #7f8c8d; font-size: 0.9rem;">
                            æç¤ºï¼šå¡«å†™ä¿¡æ¯åä¼šè‡ªåŠ¨æ ‡è®°ä¸ºå¾…ä¿å­˜
                        </span>
                    </div>

                    <table class="partners-table">
                        <thead>
                            <tr>
                                <th width="25%">åˆä¼™äººå§“å <span style="color: #e74c3c;">*</span></th>
                                <th width="25%">æŠ•èµ„é‡‘é¢ (å…ƒ) <span style="color: #e74c3c;">*</span></th>
                                <th width="25%">è”ç³»æ–¹å¼</th>
                                <th width="15%">å¤‡æ³¨</th>
                                <th width="10%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="partnersTableBody">
                            <tr id="noPartnersRow">
                                <td colspan="5" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                    <p>æš‚æ— åˆä¼™äººä¿¡æ¯</p>
                                    <p>ç‚¹å‡»ä¸Šæ–¹çš„"æ·»åŠ åˆä¼™äººè¡Œ"æŒ‰é’®å¼€å§‹æ·»åŠ </p>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="action-buttons">
                        <button id="saveChangesBtn" class="btn btn-primary">
                            <span>ğŸ’¾ ä¿å­˜åˆä¼™äººä¿¡æ¯</span>
                        </button>
                        <button id="cancelChangesBtn" class="btn btn-secondary">
                            <span>â†¶ å–æ¶ˆæœªä¿å­˜çš„æ›´æ”¹</span>
                        </button>
                        <button id="reloadDataBtn" class="btn btn-warning">
                            <span>ğŸ”„ é‡æ–°åŠ è½½æ•°æ®</span>
                        </button>
                    </div>

                    <div class="results-container">
                        <h3 class="section-title">ä»½é¢åˆ†é…ç»“æœ</h3>

                        <div class="total-investment">
                            <p>é¡¹ç›®æ€»æŠ•èµ„é¢</p>
                            <div class="total-amount" id="totalInvestment">0.00 å…ƒ</div>
                            <p>åˆä¼™äººæ€»æ•°: <span id="totalPartners">0</span> äºº</p>
                        </div>

                        <div id="resultsContainer">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>åˆä¼™äºº</th>
                                        <th>æŠ•èµ„é‡‘é¢</th>
                                        <th>æ‰€å ä»½é¢</th>
                                        <th>æ¯”ä¾‹</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 30px; color: #7f8c8d;">
                                            æš‚æ— åˆä¼™äººæ•°æ®
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="visualization">
                            <h3>ä»½é¢æ¯”ä¾‹å¯è§†åŒ–</h3>
                            <div class="chart-container" id="chartContainer">
                                <p style="text-align: center; width: 100%; color: #7f8c8d;">æš‚æ— æ•°æ®</p>
                            </div>
                            <div class="legend" id="legendContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 40px; color: #7f8c8d; padding-top: 20px; border-top: 1px solid #e1e4e8;">
            <p>Â© 2026 å¤šäººåˆä¼™æŠ•èµ„ä»½é¢åˆ†é…ç³»ç»Ÿ | åŸºäºSQLiteæ•°æ®åº“ | æ•°æ®æœ¬åœ°å®‰å…¨å­˜å‚¨</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">æ“ä½œæç¤ºï¼šå¡«å†™æ•°æ®åè¯·è®°å¾—ç‚¹å‡»ä¿å­˜æŒ‰é’®</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentProjectId = null;
        let partners = [];
        let unsavedPartners = [];
        let dirtyPartners = [];
        let deletedPartners = [];
        const chartColors = [
            "#3498db", "#2ecc71", "#e74c3c", "#f39c12", "#9b59b6",
            "#1abc9c", "#d35400", "#34495e", "#7f8c8d", "#16a085"
        ];

        // å¯¹è¯æ¡†ç›¸å…³å˜é‡
        let dialogCallback = null;
        let dialogInputCallback = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            loadRecentLogs();

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('createProjectBtn').addEventListener('click', createProject);
            document.getElementById('addPartnerBtn').addEventListener('click', addPartnerRow);
            document.getElementById('deleteProjectBtn').addEventListener('click', confirmDeleteProject);
            document.getElementById('saveChangesBtn').addEventListener('click', saveAllChanges);
            document.getElementById('cancelChangesBtn').addEventListener('click', cancelChanges);
            document.getElementById('reloadDataBtn').addEventListener('click', reloadData);
            document.getElementById('saveAllBtn').addEventListener('click', saveAllChanges);

            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('projectName').focus();
                }
                if (e.ctrlKey && e.key === 's' && currentProjectId) {
                    e.preventDefault();
                    saveAllChanges();
                }
                if (e.key === 'Escape') {
                    if (document.getElementById('customDialog').style.display === 'flex') {
                        hideDialog();
                    } else if (currentProjectId) {
                        cancelChanges();
                    }
                }
            });
        });

        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // è‡ªå®šä¹‰å¯¹è¯æ¡†å‡½æ•°
        function showDialog(title, message, type = 'info', options = {}) {
            const dialog = document.getElementById('customDialog');
            const titleElement = document.getElementById('dialogTitle');
            const messageElement = document.getElementById('dialogMessage');
            const inputElement = document.getElementById('dialogInput');
            const cancelButton = document.getElementById('dialogCancel');
            const confirmButton = document.getElementById('dialogConfirm');

            // è®¾ç½®æ ‡é¢˜å’Œæ¶ˆæ¯
            titleElement.textContent = title;
            messageElement.textContent = message;

            // æ ¹æ®ç±»å‹è®¾ç½®æŒ‰é’®é¢œè‰²
            if (type === 'danger') {
                confirmButton.className = 'btn btn-danger';
            } else if (type === 'success') {
                confirmButton.className = 'btn btn-success';
            } else {
                confirmButton.className = 'btn btn-primary';
            }

            // å¤„ç†è¾“å…¥æ¡†
            if (options.input) {
                inputElement.style.display = 'block';
                inputElement.value = options.inputValue || '';
                inputElement.placeholder = options.inputPlaceholder || '';
                inputElement.focus();
            } else {
                inputElement.style.display = 'none';
            }

            // è®¾ç½®æŒ‰é’®æ–‡æœ¬
            cancelButton.textContent = options.cancelText || 'å–æ¶ˆ';
            confirmButton.textContent = options.confirmText || 'ç¡®å®š';

            // è®¾ç½®å›è°ƒå‡½æ•°
            dialogCallback = options.onConfirm || null;
            dialogInputCallback = options.input ? options.onInputConfirm : null;

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            dialog.style.display = 'flex';
        }

        function hideDialog() {
            document.getElementById('customDialog').style.display = 'none';
            dialogCallback = null;
            dialogInputCallback = null;
        }

        function handleDialogCancel() {
            hideDialog();
        }

        function handleDialogConfirm() {
            const inputElement = document.getElementById('dialogInput');

            if (dialogInputCallback) {
                // æœ‰è¾“å…¥æ¡†çš„æƒ…å†µ
                const inputValue = inputElement.value.trim();
                dialogInputCallback(inputValue);
            } else if (dialogCallback) {
                // æ²¡æœ‰è¾“å…¥æ¡†çš„æƒ…å†µ
                dialogCallback();
            }

            hideDialog();
        }

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                const projects = await response.json();

                const projectListDiv = document.getElementById('projectList');
                const noProjectsMsg = document.getElementById('noProjectsMessage');

                if (projects.length === 0) {
                    noProjectsMsg.style.display = 'block';
                    return;
                }

                noProjectsMsg.style.display = 'none';

                let projectsHtml = '<ul class="project-list">';
                projects.forEach(project => {
                    const date = new Date(project.created_at).toLocaleDateString('zh-CN');
                    const formattedInvestment = parseFloat(project.total_investment || 0).toLocaleString('zh-CN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });

                    projectsHtml += `
                        <li class="project-item ${currentProjectId === project.id ? 'active' : ''}"
                            onclick="selectProject(${project.id}, '${project.name.replace(/'/g, "\\'")}')">
                            <div class="project-name">${project.name}</div>
                            <div class="project-info">
                                åˆ›å»ºæ—¶é—´: ${date} | æ€»æŠ•èµ„: ${formattedInvestment}å…ƒ
                            </div>
                        </li>
                    `;
                });
                projectsHtml += '</ul>';

                projectListDiv.innerHTML = projectsHtml;
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }

        // é€‰æ‹©é¡¹ç›®
        async function selectProject(projectId, projectName) {
            // å¦‚æœæœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæç¤ºç”¨æˆ·
            if (hasUnsavedChanges() && currentProjectId !== projectId) {
                showDialog(
                    'æœªä¿å­˜çš„æ›´æ”¹',
                    'å½“å‰é¡¹ç›®æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œåˆ‡æ¢é¡¹ç›®å°†ä¸¢å¤±è¿™äº›æ›´æ”¹ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                    'warning',
                    {
                        onConfirm: () => switchProject(projectId, projectName)
                    }
                );
                return;
            }

            await switchProject(projectId, projectName);  // æ·»åŠ  await
        }

        async function switchProject(projectId, projectName) {
            currentProjectId = projectId;

            // é‡ç½®æœªä¿å­˜æ•°æ®
            unsavedPartners = [];
            dirtyPartners = [];
            deletedPartners = [];

            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çš„é¡¹ç›®
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
            });

            // æ‰¾åˆ°å¹¶æ¿€æ´»å¯¹åº”çš„é¡¹ç›®
            const projectItems = document.querySelectorAll('.project-item');
            projectItems.forEach(item => {
                const projectNameElement = item.querySelector('.project-name');
                if (projectNameElement && projectNameElement.textContent.trim() === projectName) {
                    item.classList.add('active');
                }
            });

            // æ˜¾ç¤ºé¡¹ç›®å†…å®¹
            document.getElementById('noProjectSelected').style.display = 'none';
            document.getElementById('projectContent').style.display = 'block';
            document.getElementById('currentProjectName').textContent = projectName;

            // åŠ è½½é¡¹ç›®è¯¦æƒ…å’Œåˆä¼™äººæ•°æ® - ä½¿ç”¨ Promise.all ç¡®ä¿å¹¶è¡ŒåŠ è½½å®Œæˆ
            try {
                await Promise.all([
                    loadProjectDetails(projectId),
                    loadProjectPartners(projectId)
                ]);

                renderPartnersTable();

                // æ›´æ–°æ—¥å¿—
                loadRecentLogs(projectId);

                // æ›´æ–°çŠ¶æ€
                updateSaveStatus();

                // å¼ºåˆ¶é‡æ–°è®¡ç®—å’Œæ¸²æŸ“
                calculateShares();

            } catch (error) {
                console.error('åˆ‡æ¢é¡¹ç›®å¤±è´¥:', error);
                showMessage('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥', 'error');
            }
        }

        // åŠ è½½é¡¹ç›®è¯¦æƒ…
        async function loadProjectDetails(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}`);
                const project = await response.json();

                const descElement = document.getElementById('projectDescriptionDisplay');
                if (project.description && project.description.trim()) {
                    descElement.textContent = project.description;
                    descElement.style.display = 'block';
                } else {
                    descElement.textContent = 'æš‚æ— é¡¹ç›®æè¿°';
                    descElement.style.display = 'none';
                }
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // åŠ è½½é¡¹ç›®åˆä¼™äºº
        async function loadProjectPartners(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}/partners`);
                partners = await response.json();

                // æ¸…ç©ºä¹‹å‰çš„è„æ•°æ®
                dirtyPartners = [];
                deletedPartners = [];

                // æ¸²æŸ“è¡¨æ ¼
                renderPartnersTable();

                // é‡æ–°è®¡ç®—ä»½é¢
                calculateShares();

                // æ›´æ–°çŠ¶æ€
                updateSaveStatus();

            } catch (error) {
                console.error('åŠ è½½åˆä¼™äººæ•°æ®å¤±è´¥:', error);
                showMessage('åŠ è½½åˆä¼™äººæ•°æ®å¤±è´¥', 'error');

                // å¦‚æœå¤±è´¥ï¼Œæ¸…ç©ºæ•°æ®
                partners = [];
                renderPartnersTable();
                calculateShares();
            }
        }

        // æ¸²æŸ“åˆä¼™äººè¡¨æ ¼
        function renderPartnersTable() {
            const tableBody = document.getElementById('partnersTableBody');
            const noPartnersRow = document.getElementById('noPartnersRow');

            if (partners.length === 0 && unsavedPartners.length === 0) {
                noPartnersRow.style.display = '';
                return;
            }

            noPartnersRow.style.display = 'none';
            let html = '';

            // æ¸²æŸ“å·²ä¿å­˜çš„åˆä¼™äºº
            partners.forEach((partner, index) => {
                const isDirty = dirtyPartners.some(p => p.id === partner.id);
                const isDeleted = deletedPartners.includes(partner.id);

                if (isDeleted) return;

                html += `
                    <tr data-id="${partner.id}" class="partner-row ${isDirty ? 'dirty' : ''}">
                        <td>
                            <input type="text" class="partner-name" value="${partner.name || ''}"
                                   placeholder="è¯·è¾“å…¥åˆä¼™äººå§“å" required
                                   oninput="markPartnerDirty(${partner.id})">
                            ${isDirty ? '<span class="status-indicator status-unsaved"></span>' : ''}
                        </td>
                        <td>
                            <input type="number" class="partner-investment" value="${partner.investment || ''}"
                                   min="0" step="0.01" placeholder="è¯·è¾“å…¥æŠ•èµ„é‡‘é¢" required
                                   oninput="markPartnerDirty(${partner.id})">
                        </td>
                        <td>
                            <input type="text" class="partner-contact" value="${partner.contact_info || ''}"
                                   placeholder="ç”µè¯/é‚®ç®±"
                                   oninput="markPartnerDirty(${partner.id})">
                        </td>
                        <td>
                            <input type="text" class="partner-notes" value="${partner.notes || ''}"
                                   placeholder="å¤‡æ³¨ä¿¡æ¯"
                                   oninput="markPartnerDirty(${partner.id})">
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="confirmDeletePartner(${partner.id})">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            });

            // æ¸²æŸ“æœªä¿å­˜çš„æ–°å¢åˆä¼™äºº
            unsavedPartners.forEach(partner => {
                html += `
                    <tr data-temp-id="${partner.tempId}" class="partner-row new">
                        <td>
                            <input type="text" class="partner-name" value="${partner.name || ''}"
                                   placeholder="è¯·è¾“å…¥åˆä¼™äººå§“å" required
                                   oninput="updateUnsavedPartner('${partner.tempId}', 'name', this.value)">
                            <span class="status-indicator status-new"></span>
                        </td>
                        <td>
                            <input type="number" class="partner-investment" value="${partner.investment || ''}"
                                   min="0" step="0.01" placeholder="è¯·è¾“å…¥æŠ•èµ„é‡‘é¢" required
                                   oninput="updateUnsavedPartner('${partner.tempId}', 'investment', this.value)">
                        </td>
                        <td>
                            <input type="text" class="partner-contact" value="${partner.contact_info || ''}"
                                   placeholder="ç”µè¯/é‚®ç®±"
                                   oninput="updateUnsavedPartner('${partner.tempId}', 'contact_info', this.value)">
                        </td>
                        <td>
                            <input type="text" class="partner-notes" value="${partner.notes || ''}"
                                   placeholder="å¤‡æ³¨ä¿¡æ¯"
                                   oninput="updateUnsavedPartner('${partner.tempId}', 'notes', this.value)">
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="removeUnsavedPartner('${partner.tempId}')">
                                å–æ¶ˆ
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            calculateShares();
        }

        // æ ‡è®°åˆä¼™äººéœ€è¦æ›´æ–°
        function markPartnerDirty(partnerId) {
            const row = document.querySelector(`tr[data-id="${partnerId}"]`);
            if (!row) return;

            // è·å–å½“å‰å€¼
            const name = row.querySelector('.partner-name').value.trim();
            const investment = parseFloat(row.querySelector('.partner-investment').value) || 0;
            const contact = row.querySelector('.partner-contact').value.trim();
            const notes = row.querySelector('.partner-notes').value.trim();

            // æ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰å˜åŒ–
            const originalPartner = partners.find(p => p.id === partnerId);
            if (originalPartner) {
                const hasChanged = name !== originalPartner.name ||
                    investment !== parseFloat(originalPartner.investment) ||
                    contact !== (originalPartner.contact_info || '') ||
                    notes !== (originalPartner.notes || '');

                if (hasChanged) {
                    // æ·»åŠ åˆ°è„æ•°æ®åˆ—è¡¨
                    const existingIndex = dirtyPartners.findIndex(p => p.id === partnerId);
                    if (existingIndex === -1) {
                        dirtyPartners.push({
                            id: partnerId,
                            name: name,
                            investment: investment,
                            contact_info: contact,
                            notes: notes
                        });
                    } else {
                        dirtyPartners[existingIndex] = {
                            id: partnerId,
                            name: name,
                            investment: investment,
                            contact_info: contact,
                            notes: notes
                        };
                    }

                    row.classList.add('dirty');
                }
            }

            updateSaveStatus();
        }

        // ç¡®è®¤åˆ é™¤åˆä¼™äºº
        function confirmDeletePartner(partnerId) {
            const partner = partners.find(p => p.id === partnerId);
            if (!partner) return;

            if (partners.length <= 1 && unsavedPartners.length === 0) {
                showDialog('æ“ä½œå¤±è´¥', 'è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªåˆä¼™äºº', 'error');
                return;
            }

            showDialog(
                'ç¡®è®¤åˆ é™¤',
                `ç¡®å®šè¦åˆ é™¤åˆä¼™äºº "${partner.name}" å—ï¼Ÿ`,
                'danger',
                {
                    onConfirm: () => markPartnerForDeletion(partnerId)
                }
            );
        }

        // æ ‡è®°åˆä¼™äººå¾…åˆ é™¤
        function markPartnerForDeletion(partnerId) {
            // æ·»åŠ åˆ°åˆ é™¤åˆ—è¡¨
            if (!deletedPartners.includes(partnerId)) {
                deletedPartners.push(partnerId);
            }

            // ä»è§†å›¾ä¸­ç§»é™¤
            const row = document.querySelector(`tr[data-id="${partnerId}"]`);
            if (row) {
                row.remove();
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰åˆä¼™äºº
            const remainingRows = document.querySelectorAll('.partners-table tr:not(#noPartnersRow)');
            if (remainingRows.length === 0) {
                document.getElementById('noPartnersRow').style.display = '';
            }

            // æ›´æ–°è®¡ç®—
            calculateShares();
            updateSaveStatus();
            showMessage('åˆä¼™äººå·²æ ‡è®°ä¸ºåˆ é™¤ï¼Œè¯·ä¿å­˜æ›´æ”¹', 'info');
        }

        // æ·»åŠ åˆä¼™äººè¡Œ - ä¿®å¤ç‰ˆæœ¬
        function addPartnerRow() {
            if (!currentProjectId) {
                showDialog('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªé¡¹ç›®', 'error');
                return;
            }

            // ç”Ÿæˆä¸´æ—¶ID
            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // æ·»åŠ åˆ°æœªä¿å­˜åˆ—è¡¨
            unsavedPartners.push({
                tempId: tempId,
                name: '',
                investment: '',
                contact_info: '',
                notes: ''
            });

            console.log('æ·»åŠ æ–°åˆä¼™äººè¡Œï¼Œä¸´æ—¶ID:', tempId, 'æœªä¿å­˜åˆä¼™äººæ•°é‡:', unsavedPartners.length);

            // éšè—"æš‚æ— åˆä¼™äºº"è¡Œ
            const noPartnersRow = document.getElementById('noPartnersRow');
            if (noPartnersRow) {
                noPartnersRow.style.display = 'none';
            }

            // åˆ›å»ºæ–°è¡Œå¹¶æ·»åŠ åˆ°è¡¨æ ¼
            const tableBody = document.getElementById('partnersTableBody');

            const newRow = document.createElement('tr');
            newRow.className = 'partner-row new';
            newRow.setAttribute('data-temp-id', tempId);

            newRow.innerHTML = `
                <td>
                    <input type="text" class="partner-name" value=""
                           placeholder="è¯·è¾“å…¥åˆä¼™äººå§“å" required
                           oninput="updateUnsavedPartner('${tempId}', 'name', this.value)">
                    <span class="status-indicator status-new"></span>
                </td>
                <td>
                    <input type="number" class="partner-investment" value=""
                           min="0" step="0.01" placeholder="è¯·è¾“å…¥æŠ•èµ„é‡‘é¢" required
                           oninput="updateUnsavedPartner('${tempId}', 'investment', this.value)">
                </td>
                <td>
                    <input type="text" class="partner-contact" value=""
                           placeholder="ç”µè¯/é‚®ç®±"
                           oninput="updateUnsavedPartner('${tempId}', 'contact_info', this.value)">
                </td>
                <td>
                    <input type="text" class="partner-notes" value=""
                           placeholder="å¤‡æ³¨ä¿¡æ¯"
                           oninput="updateUnsavedPartner('${tempId}', 'notes', this.value)">
                </td>
                <td>
                    <button class="btn btn-danger" onclick="removeUnsavedPartner('${tempId}')">
                        å–æ¶ˆ
                    </button>
                </td>
            `;

            tableBody.appendChild(newRow);

            // è‡ªåŠ¨èšç„¦åˆ°æ–°è¡Œçš„å§“åè¾“å…¥æ¡†
            setTimeout(() => {
                const nameInput = newRow.querySelector('.partner-name');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);

            // æ›´æ–°è®¡ç®—å’ŒçŠ¶æ€
            calculateShares();
            updateSaveStatus();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showMessage('å·²æ·»åŠ æ–°åˆä¼™äººè¡Œï¼Œè¯·å¡«å†™ä¿¡æ¯', 'success');
        }

        // æ›´æ–°æœªä¿å­˜çš„åˆä¼™äºº
        function updateUnsavedPartner(tempId, field, value) {
            const partnerIndex = unsavedPartners.findIndex(p => p.tempId === tempId);
            if (partnerIndex !== -1) {
                unsavedPartners[partnerIndex][field] = value;
                // å®æ—¶è®¡ç®—ä»½é¢
                calculateShares();
                updateSaveStatus();
            }
        }

        // ç§»é™¤æœªä¿å­˜çš„åˆä¼™äºº
        function removeUnsavedPartner(tempId) {
            unsavedPartners = unsavedPartners.filter(p => p.tempId !== tempId);

            // ä»DOMä¸­ç§»é™¤å¯¹åº”è¡Œ
            const row = document.querySelector(`tr[data-temp-id="${tempId}"]`);
            if (row) {
                row.remove();
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰åˆä¼™äººè¡Œ
            const tableBody = document.getElementById('partnersTableBody');
            const rows = tableBody.querySelectorAll('tr');
            if (rows.length === 1 && rows[0].id === 'noPartnersRow') {
                document.getElementById('noPartnersRow').style.display = '';
            }

            calculateShares();
            updateSaveStatus();
        }

        // ä¿å­˜æ‰€æœ‰æ›´æ”¹
        async function saveAllChanges() {
            if (!currentProjectId) return;

            // éªŒè¯æ•°æ®
            if (!validateAllPartners()) {
                return;
            }

            showLoading();
            let hasError = false;
            let savedCount = 0;
            const errors = [];

            try {
                // ä¿å­˜æ–°å¢çš„åˆä¼™äºº
                for (const partner of unsavedPartners) {
                    try {
                        const response = await fetch(`/api/project/${currentProjectId}/partners`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: partner.name,
                                investment: parseFloat(partner.investment) || 0,
                                contact_info: partner.contact_info || '',
                                notes: partner.notes || ''
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const result = await response.json();

                        if (result.success) {
                            savedCount++;
                        } else {
                            hasError = true;
                            errors.push(`æ–°å¢åˆä¼™äººå¤±è´¥: ${partner.name}`);
                        }
                    } catch (error) {
                        console.error('ä¿å­˜åˆä¼™äººå¤±è´¥:', error);
                        hasError = true;
                        errors.push(`æ–°å¢åˆä¼™äººå¤±è´¥: ${partner.name} - ${error.message}`);
                    }
                }

                // æ›´æ–°å·²ä¿®æ”¹çš„åˆä¼™äºº
                for (const partner of dirtyPartners) {
                    try {
                        const response = await fetch(`/api/partner/${partner.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: partner.name,
                                investment: partner.investment,
                                contact_info: partner.contact_info,
                                notes: partner.notes
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const result = await response.json();

                        if (result.success) {
                            savedCount++;
                        } else {
                            hasError = true;
                            errors.push(`æ›´æ–°åˆä¼™äººå¤±è´¥: ${partner.name}`);
                        }
                    } catch (error) {
                        console.error('æ›´æ–°åˆä¼™äººå¤±è´¥:', error);
                        hasError = true;
                        errors.push(`æ›´æ–°åˆä¼™äººå¤±è´¥: ${partner.name} - ${error.message}`);
                    }
                }

                // åˆ é™¤æ ‡è®°ä¸ºåˆ é™¤çš„åˆä¼™äºº
                for (const partnerId of deletedPartners) {
                    try {
                        const partner = partners.find(p => p.id === partnerId);
                        const response = await fetch(`/api/partner/${partnerId}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const result = await response.json();

                        if (result.success) {
                            savedCount++;
                        } else {
                            hasError = true;
                            errors.push(`åˆ é™¤åˆä¼™äººå¤±è´¥: ${partner?.name || partnerId}`);
                        }
                    } catch (error) {
                        console.error('åˆ é™¤åˆä¼™äººå¤±è´¥:', error);
                        hasError = true;
                        errors.push(`åˆ é™¤åˆä¼™äººå¤±è´¥: ${partner?.name || partnerId} - ${error.message}`);
                    }
                }

                if (hasError) {
                    const errorMessage = errors.length > 3 ?
                        `éƒ¨åˆ†æ“ä½œä¿å­˜å¤±è´¥ï¼ˆå…±${errors.length}ä¸ªé”™è¯¯ï¼‰` :
                        errors.join('\\n');
                    showDialog('ä¿å­˜å¤±è´¥', errorMessage, 'error');
                } else if (savedCount > 0) {
                    showDialog('ä¿å­˜æˆåŠŸ', `æˆåŠŸä¿å­˜ ${savedCount} æ¡æ›´æ”¹`, 'success', {
                        onConfirm: async () => {
                            // é‡ç½®çŠ¶æ€
                            unsavedPartners = [];
                            dirtyPartners = [];
                            deletedPartners = [];

                            // é‡æ–°åŠ è½½æ•°æ®
                            await loadProjectPartners(currentProjectId);
                            loadRecentLogs(currentProjectId);
                            loadProjects();

                            updateSaveStatus();
                        }
                    });
                } else {
                    showDialog('æç¤º', 'æ²¡æœ‰éœ€è¦ä¿å­˜çš„æ›´æ”¹', 'info');
                }
            } finally {
                hideLoading();
            }
        }

        // éªŒè¯æ‰€æœ‰åˆä¼™äººæ•°æ®
        function validateAllPartners() {
            let isValid = true;

            // éªŒè¯å·²å­˜åœ¨çš„åˆä¼™äºº
            for (const partner of partners) {
                if (deletedPartners.includes(partner.id)) continue;

                const row = document.querySelector(`tr[data-id="${partner.id}"]`);
                if (row) {
                    const nameInput = row.querySelector('.partner-name');
                    const investmentInput = row.querySelector('.partner-investment');
                    const name = nameInput.value.trim();
                    const investment = investmentInput.value.trim();

                    // é‡ç½®é”™è¯¯çŠ¶æ€
                    nameInput.classList.remove('input-error');
                    investmentInput.classList.remove('input-error');

                    if (!name) {
                        nameInput.classList.add('input-error');
                        nameInput.focus();
                        isValid = false;
                    }
                    if (!investment) {
                        investmentInput.classList.add('input-error');
                        if (isValid) investmentInput.focus();
                        isValid = false;
                    }
                }
            }

            // éªŒè¯æ–°å¢çš„åˆä¼™äºº
            unsavedPartners.forEach((partner, index) => {
                const row = document.querySelector(`tr[data-temp-id="${partner.tempId}"]`);
                if (row) {
                    const nameInput = row.querySelector('.partner-name');
                    const investmentInput = row.querySelector('.partner-investment');

                    nameInput.classList.remove('input-error');
                    investmentInput.classList.remove('input-error');

                    if (!partner.name) {
                        nameInput.classList.add('input-error');
                        if (isValid) nameInput.focus();
                        isValid = false;
                    }
                    if (!partner.investment) {
                        investmentInput.classList.add('input-error');
                        if (isValid) investmentInput.focus();
                        isValid = false;
                    }
                }
            });

            if (!isValid) {
                showDialog('éªŒè¯å¤±è´¥', 'è¯·æ£€æŸ¥è¾“å…¥æ•°æ®ï¼Œæ‰€æœ‰åˆä¼™äººå¿…é¡»å¡«å†™å§“åå’ŒæŠ•èµ„é‡‘é¢', 'error');
            }

            return isValid;
        }

        // å–æ¶ˆæ›´æ”¹
        function cancelChanges() {
            if (!hasUnsavedChanges()) {
                showDialog('æç¤º', 'æ²¡æœ‰æœªä¿å­˜çš„æ›´æ”¹', 'info');
                return;
            }

            showDialog(
                'ç¡®è®¤å–æ¶ˆ',
                'ç¡®å®šè¦å–æ¶ˆæ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹å—ï¼Ÿ',
                'warning',
                {
                    onConfirm: () => {
                        unsavedPartners = [];
                        dirtyPartners = [];
                        deletedPartners = [];

                        // é‡æ–°åŠ è½½æ•°æ®
                        if (currentProjectId) {
                            loadProjectPartners(currentProjectId);
                        }

                        updateSaveStatus();
                        showMessage('å·²å–æ¶ˆæ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹', 'info');
                    }
                }
            );
        }

        // é‡æ–°åŠ è½½æ•°æ®
        function reloadData() {
            if (!currentProjectId) return;

            if (hasUnsavedChanges()) {
                showDialog(
                    'ç¡®è®¤é‡æ–°åŠ è½½',
                    'æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œé‡æ–°åŠ è½½å°†ä¸¢å¤±è¿™äº›æ›´æ”¹ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                    'warning',
                    {
                        onConfirm: () => {
                            unsavedPartners = [];
                            dirtyPartners = [];
                            deletedPartners = [];

                            loadProjectPartners(currentProjectId);
                            showMessage('æ•°æ®å·²é‡æ–°åŠ è½½', 'info');
                        }
                    }
                );
                return;
            }

            loadProjectPartners(currentProjectId);
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
        function hasUnsavedChanges() {
            return unsavedPartners.length > 0 ||
                   dirtyPartners.length > 0 ||
                   deletedPartners.length > 0;
        }

        // æ›´æ–°ä¿å­˜çŠ¶æ€æ˜¾ç¤º
        function updateSaveStatus() {
            const statusElement = document.getElementById('saveStatus');
            const saveButton = document.getElementById('saveChangesBtn');
            const cancelButton = document.getElementById('cancelChangesBtn');

            if (hasUnsavedChanges()) {
                statusElement.innerHTML = '<span class="status-indicator status-unsaved"></span> æœ‰æœªä¿å­˜çš„æ›´æ”¹';
                statusElement.style.color = '#f39c12';

                // ç»Ÿè®¡æ›´æ”¹æ•°é‡
                const totalChanges = unsavedPartners.length + dirtyPartners.length + deletedPartners.length;
                saveButton.innerHTML = `<span>ğŸ’¾ ä¿å­˜æ›´æ”¹ (${totalChanges} å¤„)</span>`;
                saveButton.disabled = false;
                cancelButton.disabled = false;
            } else {
                statusElement.innerHTML = '<span class="status-indicator status-saved"></span> å·²ä¿å­˜';
                statusElement.style.color = '#2ecc71';
                saveButton.innerHTML = `<span>ğŸ’¾ ä¿å­˜åˆä¼™äººä¿¡æ¯</span>`;
                saveButton.disabled = true;
                cancelButton.disabled = true;
            }
        }

        // è®¡ç®—ä»½é¢
        function calculateShares() {
            // æ”¶é›†æ‰€æœ‰åˆä¼™äººæ•°æ®ï¼ˆåŒ…æ‹¬æœªä¿å­˜çš„ï¼‰
            const allPartners = [];

            // æ·»åŠ å·²ä¿å­˜ä¸”æœªåˆ é™¤çš„åˆä¼™äºº
            partners.forEach(partner => {
                if (!deletedPartners.includes(partner.id)) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰è„æ•°æ®
                    const dirtyData = dirtyPartners.find(p => p.id === partner.id);
                    if (dirtyData) {
                        allPartners.push(dirtyData);
                    } else {
                        allPartners.push(partner);
                    }
                }
            });

            // æ·»åŠ æœªä¿å­˜çš„æ–°å¢åˆä¼™äºº
            unsavedPartners.forEach(partner => {
                allPartners.push({
                    name: partner.name || 'æ–°åˆä¼™äºº',
                    investment: parseFloat(partner.investment) || 0
                });
            });

            if (allPartners.length === 0) {
                document.getElementById('totalInvestment').textContent = '0.00 å…ƒ';
                document.getElementById('totalPartners').textContent = '0';

                document.getElementById('resultsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: #7f8c8d;">
                            æš‚æ— åˆä¼™äººæ•°æ®
                        </td>
                    </tr>
                `;

                document.getElementById('chartContainer').innerHTML =
                    '<p style="text-align: center; width: 100%; color: #7f8c8d;">æš‚æ— æ•°æ®</p>';
                document.getElementById('legendContainer').innerHTML = '';

                return;
            }

            // è®¡ç®—æ€»æŠ•èµ„é¢
            const totalInvestment = allPartners.reduce((sum, partner) => {
                return sum + (parseFloat(partner.investment) || 0);
            }, 0);

            // æ›´æ–°æ€»æŠ•èµ„é¢æ˜¾ç¤º
            document.getElementById('totalInvestment').textContent =
                totalInvestment.toLocaleString('zh-CN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + ' å…ƒ';

            // æ›´æ–°åˆä¼™äººæ€»æ•°
            document.getElementById('totalPartners').textContent = allPartners.length;

            // æ¸²æŸ“ç»“æœè¡¨æ ¼
            renderResultsTable(allPartners, totalInvestment);

            // æ¸²æŸ“å›¾è¡¨
            renderChart(allPartners, totalInvestment);
        }

        // æ¸²æŸ“ç»“æœè¡¨æ ¼
        function renderResultsTable(allPartners, totalInvestment) {
            const tableBody = document.getElementById('resultsTableBody');
            let html = '';

            allPartners.forEach((partner, index) => {
                const investment = parseFloat(partner.investment) || 0;
                const sharePercentage = totalInvestment > 0 ? (investment / totalInvestment) * 100 : 0;
                const colorIndex = index % chartColors.length;
                const color = chartColors[colorIndex];

                html += `
                    <tr>
                        <td class="highlight">${partner.name || 'æœªå‘½å'}</td>
                        <td>${investment.toLocaleString('zh-CN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        })} å…ƒ</td>
                        <td>
                            <div>${sharePercentage.toFixed(2)}%</div>
                            <div class="share-bar-container">
                                <div class="share-bar" style="width: ${sharePercentage}%; background-color: ${color};"></div>
                            </div>
                        </td>
                        <td class="highlight">${(sharePercentage / 100).toFixed(4)}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(allPartners, totalInvestment) {
            const chartContainer = document.getElementById('chartContainer');
            const legendContainer = document.getElementById('legendContainer');

            chartContainer.innerHTML = '';
            legendContainer.innerHTML = '';

            if (totalInvestment === 0 || allPartners.length === 0) {
                chartContainer.innerHTML = '<p style="text-align: center; width: 100%; color: #7f8c8d;">æš‚æ— æ•°æ®</p>';
                return;
            }

            // æ‰¾å‡ºæœ€å¤§æŠ•èµ„é‡‘é¢ç”¨äºè®¡ç®—æ¯”ä¾‹
            const maxInvestment = Math.max(...allPartners.map(p => parseFloat(p.investment) || 0));

            allPartners.forEach((partner, index) => {
                const investment = parseFloat(partner.investment) || 0;
                const sharePercentage = totalInvestment > 0 ? (investment / totalInvestment) * 100 : 0;
                const barHeight = maxInvestment > 0 ? (investment / maxInvestment) * 80 : 0;
                const colorIndex = index % chartColors.length;
                const color = chartColors[colorIndex];

                // åˆ›å»ºæŸ±çŠ¶å›¾
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${barHeight}%`;
                bar.style.backgroundColor = color;

                // æ·»åŠ æ ‡ç­¾
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = partner.name.length > 6 ? partner.name.substring(0, 5) + '...' : partner.name;

                // æ·»åŠ æ•°å€¼
                const value = document.createElement('div');
                value.className = 'chart-bar-value';
                value.textContent = `${sharePercentage.toFixed(1)}%`;

                bar.appendChild(value);
                bar.appendChild(label);
                chartContainer.appendChild(bar);

                // æ·»åŠ å›¾ä¾‹
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${color};"></div>
                    <span>${partner.name}: ${sharePercentage.toFixed(2)}%</span>
                `;
                legendContainer.appendChild(legendItem);
            });
        }

        // åˆ›å»ºæ–°é¡¹ç›®
        async function createProject() {
            const nameInput = document.getElementById('projectName');
            const descriptionInput = document.getElementById('projectDescription');

            const name = nameInput.value.trim();
            if (!name) {
                showDialog('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥é¡¹ç›®åç§°', 'error');
                nameInput.focus();
                return;
            }

            showLoading();
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        description: descriptionInput.value.trim()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // æ¸…ç©ºè¡¨å•
                    nameInput.value = '';
                    descriptionInput.value = '';

                    // åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                    await loadProjects();  // ç¡®ä¿è°ƒç”¨å¹¶ç­‰å¾…å®Œæˆ
                    loadRecentLogs();

                    // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„é¡¹ç›®
                    setTimeout(() => {
                        selectProject(result.project_id, name);
                    }, 100);  // ç¼©çŸ­å»¶æ—¶ï¼Œç¡®ä¿åˆ—è¡¨å·²åˆ·æ–°

                    showDialog('åˆ›å»ºæˆåŠŸ', 'é¡¹ç›®åˆ›å»ºæˆåŠŸ', 'success');
                    window.location.reload()
                } else {
                    throw new Error('åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºé¡¹ç›®å¤±è´¥:', error);
                showDialog('åˆ›å»ºå¤±è´¥', `åˆ›å»ºé¡¹ç›®å¤±è´¥: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¡®è®¤åˆ é™¤é¡¹ç›®
        function confirmDeleteProject() {
            if (!currentProjectId) return;

            showDialog(
                'ç¡®è®¤åˆ é™¤',
                'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿè¿™å°†åˆ é™¤é¡¹ç›®ä¸­çš„æ‰€æœ‰åˆä¼™äººæ•°æ®ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
                'danger',
                {
                    confirmText: 'åˆ é™¤',
                    onConfirm: deleteCurrentProject
                }
            );
        }

        // åˆ é™¤å½“å‰é¡¹ç›®
        async function deleteCurrentProject() {
            showLoading();
            try {
                const response = await fetch(`/api/project/${currentProjectId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showDialog('åˆ é™¤æˆåŠŸ', 'é¡¹ç›®åˆ é™¤æˆåŠŸ', 'success', {
                        onConfirm: () => {
                            // é‡ç½®å½“å‰é¡¹ç›®
                            currentProjectId = null;
                            partners = [];
                            unsavedPartners = [];
                            dirtyPartners = [];
                            deletedPartners = [];

                            // åˆ·æ–°UI
                            document.getElementById('noProjectSelected').style.display = 'block';
                            document.getElementById('projectContent').style.display = 'none';

                            // åˆ·æ–°é¡¹ç›®åˆ—è¡¨å’Œæ—¥å¿—
                            loadProjects();
                            loadRecentLogs();
                            window.location.reload()
                        }
                    });
                } else {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤é¡¹ç›®å¤±è´¥:', error);
                showDialog('åˆ é™¤å¤±è´¥', `åˆ é™¤é¡¹ç›®å¤±è´¥: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æ“ä½œæ—¥å¿—
        async function loadRecentLogs(projectId = null) {
            try {
                const url = projectId ? `/api/logs?project_id=${projectId}` : '/api/logs';
                const response = await fetch(url);
                const logs = await response.json();

                const logsDiv = document.getElementById('recentLogs');

                if (logs.length === 0) {
                    logsDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">æš‚æ— æ“ä½œè®°å½•</p>';
                    return;
                }

                let html = '';
                logs.forEach(log => {
                    const time = new Date(log.operated_at).toLocaleString('zh-CN');
                    html += `
                        <div class="log-item">
                            <div>${log.operation_type} - ${log.details}</div>
                            <div class="log-time">${time} - ${log.operated_by}</div>
                        </div>
                    `;
                });

                logsDiv.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');

            messageArea.innerHTML = `
                <div class="message ${type}">
                    ${message}
                </div>
            `;

            messageArea.style.display = 'block';

            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>