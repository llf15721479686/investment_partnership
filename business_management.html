<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶³æµ´åº—ä¸šåŠ¡ç®¡ç†ç³»ç»Ÿ</title>
    <!-- CSSæ ·å¼ä¿æŒä¸å˜ï¼ˆä¸ä¹‹å‰ç›¸åŒï¼‰ -->
    <style>
        /* ä¿æŒä¹‹å‰çš„CSSæ ·å¼ä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ä¸»å®¹å™¨ */
        .business-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* å¯¼èˆªæ  */
        .main-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0 30px;
        }

        .nav-tabs {
            display: flex;
            gap: 2px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 20px 25px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border-bottom-color: white;
        }

        /* å¤´éƒ¨ä¿¡æ¯ */
        .header-info {
            background: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .project-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-planning {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            color: #9b2c2c;
        }

        .status-setting {
            background: linear-gradient(135deg, #feebc8, #ed8936);
            color: #9c4221;
        }

        .status-operating {
            background: linear-gradient(135deg, #c6f6d5, #48bb78);
            color: #276749;
        }

        /* ä»ªè¡¨æ¿å¡ç‰‡ */
        .dashboard {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            background: #f7fafc;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .icon-equipment {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .icon-decoration {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .icon-inventory {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .icon-budget {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .card-title {
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 28px;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .card-change {
            font-size: 13px;
            font-weight: 600;
        }

        .change-positive {
            color: #48bb78;
        }

        .change-negative {
            color: #f56565;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            padding: 30px;
            display: none;
        }

        .content-area.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 6px;
            height: 24px;
            border-radius: 3px;
        }

        .section-equipment .section-title::before {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .section-decoration .section-title::before {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .section-inventory .section-title::before {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .section-budget .section-title::before {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .section-rooms .section-title::before {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .section-revenue .section-title::before {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .data-table th {
            background: #f7fafc;
            padding: 18px 20px;
            font-weight: 600;
            text-align: left;
            font-size: 14px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tag {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .tag-normal {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #276749;
        }

        .tag-maintenance {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #9b2c2c;
        }

        .tag-scrap {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            color: #4a5568;
        }

        .tag-vip {
            background: linear-gradient(135deg, #e9d8fd, #d6bcfa);
            color: #553c9a;
        }

        .tag-budget {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            color: #2c5282;
        }

        .tag-actual {
            background: linear-gradient(135deg, #fed7e2, #fbb6ce);
            color: #97266d;
        }

        .tag-pending {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #9b2c2c;
        }

        .tag-in-progress {
            background: linear-gradient(135deg, #feebc8, #fbd38d);
            color: #9c4221;
        }

        .tag-completed {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #276749;
        }

        /* è¡¨å•æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #2d3748;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group.required label::after {
            content: ' *';
            color: #f56565;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
        }

        /* æˆ¿é—´å¡ç‰‡ */
        .room-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .room-card.available {
            border-color: #48bb78;
        }

        .room-card.occupied {
            border-color: #f56565;
        }

        .room-card.cleaning {
            border-color: #ed8936;
        }

        .room-card.maintenance {
            border-color: #718096;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
        }

        .room-type {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .room-type.vip {
            background: linear-gradient(135deg, #e9d8fd, #d6bcfa);
            color: #553c9a;
        }

        .room-type.normal {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            color: #2c5282;
        }

        .room-type.luxury {
            background: linear-gradient(135deg, #fed7e2, #fbb6ce);
            color: #97266d;
        }

        .room-details {
            margin-bottom: 15px;
        }

        .room-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .room-detail-label {
            color: #718096;
        }

        .room-detail-value {
            color: #2d3748;
            font-weight: 600;
        }

        .room-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
        }

        .room-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                flex: 1;
                justify-content: center;
                padding: 15px 10px;
                font-size: 13px;
            }

            .header-info {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* åº“å­˜é¢„è­¦ */
        .inventory-warning {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .warning-content {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #9b2c2c;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- HTMLç»“æ„ä¿æŒä¸å˜ -->
    <div class="business-container">
        <!-- å¯¼èˆªæ  -->
        <div class="main-nav">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('dashboard')">
                    ğŸ“Š ä»ªè¡¨æ¿
                </div>
                <div class="nav-tab" onclick="switchTab('equipment')">
                    ğŸ› ï¸ è®¾å¤‡ç®¡ç†
                </div>
                <div class="nav-tab" onclick="switchTab('decoration')">
                    ğŸ—ï¸ è£…ä¿®ç®¡ç†
                </div>
                <div class="nav-tab" onclick="switchTab('inventory')">
                    ğŸ“¦ ç‰©æ–™åº“å­˜
                </div>
                <div class="nav-tab" onclick="switchTab('rooms')">
                    ğŸšª æˆ¿é—´ç®¡ç†
                </div>
                <div class="nav-tab" onclick="switchTab('budget')">
                    ğŸ’° æˆæœ¬é¢„ç®—
                </div>
                <div class="nav-tab" onclick="switchTab('revenue')">
                    ğŸ“ˆ æ”¶å…¥é¢„æµ‹
                </div>
                <div class="nav-tab" onclick="window.location.href='/'">
                    â† è¿”å›æŠ•èµ„ç®¡ç†
                </div>
            </div>
        </div>

        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header-info">
            <div class="project-selector">
                <select id="projectSelect" class="form-control" style="width: 300px;" onchange="loadProjectData(this.value)">
                    <option value="">è¯·é€‰æ‹©è¶³æµ´åº—é¡¹ç›®...</option>
                </select>
                <div class="project-info">
                    <span id="projectStatus" class="project-status status-planning">è§„åˆ’ä¸­</span>
                    <span id="projectProgress" style="color: #718096; font-size: 14px;">-</span>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" onclick="exportReport()">
                    ğŸ“„ å¯¼å‡ºæŠ¥å‘Š
                </button>
            </div>
        </div>

        <!-- ä»ªè¡¨æ¿ -->
        <div id="dashboard" class="content-area active">
            <div class="dashboard">
                <div class="dashboard-card">
                    <div class="card-icon icon-equipment">
                        ğŸ› ï¸
                    </div>
                    <div class="card-title">è®¾å¤‡æ€»ä»·å€¼</div>
                    <div class="card-value" id="totalEquipmentValue">0 å…ƒ</div>
                    <div class="card-change" id="equipmentStatus">0å°è®¾å¤‡</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon icon-decoration">
                        ğŸ—ï¸
                    </div>
                    <div class="card-title">è£…ä¿®æ€»é¢„ç®—</div>
                    <div class="card-value" id="totalDecorationBudget">0 å…ƒ</div>
                    <div class="card-change" id="decorationStatus">0é¡¹è£…ä¿®</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon icon-inventory">
                        ğŸ“¦
                    </div>
                    <div class="card-title">ç‰©æ–™åº“å­˜</div>
                    <div class="card-value" id="totalInventoryValue">0 å…ƒ</div>
                    <div class="card-change" id="inventoryStatus">0ç§ç‰©æ–™</div>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon icon-budget">
                        ğŸ’°
                    </div>
                    <div class="card-title">æ€»æˆæœ¬é¢„ç®—</div>
                    <div class="card-value" id="totalCostBudget">0 å…ƒ</div>
                    <div class="card-change" id="budgetStatus">0é¡¹é¢„ç®—</div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="chart-container">
                <div class="chart-title">æˆæœ¬åˆ†å¸ƒå›¾</div>
                <canvas id="costDistributionChart" height="300"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">é¡¹ç›®è¿›åº¦</div>
                <canvas id="projectProgressChart" height="200"></canvas>
            </div>
        </div>

        <!-- è®¾å¤‡ç®¡ç† -->
        <div id="equipment" class="content-area section-equipment">
            <div class="section-header">
                <h2 class="section-title">ğŸ› ï¸ è®¾å¤‡ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="showEquipmentModal()">
                    â• æ·»åŠ è®¾å¤‡
                </button>
            </div>

            <div style="margin-bottom: 20px; display: flex; gap: 15px;">
                <select id="equipmentTypeFilter" class="form-control" style="width: 200px;" onchange="filterEquipment()">
                    <option value="">æ‰€æœ‰è®¾å¤‡ç±»å‹</option>
                    <option value="è¶³æµ´è®¾å¤‡">è¶³æµ´è®¾å¤‡</option>
                    <option value="æŒ‰æ‘©è®¾å¤‡">æŒ‰æ‘©è®¾å¤‡</option>
                    <option value="æ°´å¤„ç†è®¾å¤‡">æ°´å¤„ç†è®¾å¤‡</option>
                    <option value="å®¶å…·">å®¶å…·</option>
                    <option value="ç”µå™¨">ç”µå™¨</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <select id="equipmentStatusFilter" class="form-control" style="width: 200px;" onchange="filterEquipment()">
                    <option value="">æ‰€æœ‰çŠ¶æ€</option>
                    <option value="æ­£å¸¸">æ­£å¸¸</option>
                    <option value="ç»´ä¿®">ç»´ä¿®</option>
                    <option value="æŠ¥åºŸ">æŠ¥åºŸ</option>
                </select>
                <input type="text" id="equipmentSearch" class="form-control" style="width: 300px;" placeholder="æœç´¢è®¾å¤‡åç§°..." oninput="filterEquipment()">
            </div>

            <table class="data-table" id="equipmentTable">
                <thead>
                    <tr>
                        <th>è®¾å¤‡åç§°</th>
                        <th>ç±»å‹</th>
                        <th>è§„æ ¼</th>
                        <th>æ•°é‡</th>
                        <th>å•ä»·</th>
                        <th>æ€»ä»·</th>
                        <th>çŠ¶æ€</th>
                        <th>ä½ç½®</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="equipmentTableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #718096;">
                            æš‚æ— è®¾å¤‡æ•°æ®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- è£…ä¿®ç®¡ç† -->
        <div id="decoration" class="content-area section-decoration">
            <div class="section-header">
                <h2 class="section-title">ğŸ—ï¸ è£…ä¿®ç®¡ç†</h2>
                <button class="btn btn-success" onclick="showDecorationModal()">
                    â• æ·»åŠ è£…ä¿®é¡¹ç›®
                </button>
            </div>

            <div style="margin-bottom: 30px;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <select id="decorationTypeFilter" class="form-control" style="width: 200px;" onchange="filterDecoration()">
                        <option value="">æ‰€æœ‰è£…ä¿®ç±»å‹</option>
                        <option value="ç¡¬è£…">ç¡¬è£…</option>
                        <option value="è½¯è£…">è½¯è£…</option>
                        <option value="ç”µæ°”">ç”µæ°”</option>
                        <option value="ç®¡é“">ç®¡é“</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <select id="decorationStatusFilter" class="form-control" style="width: 200px;" onchange="filterDecoration()">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="æœªå¼€å§‹">æœªå¼€å§‹</option>
                        <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                    </select>
                </div>

                <!-- è¿›åº¦ç»Ÿè®¡ -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #4a5568;">è£…ä¿®è¿›åº¦ç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: #667eea;" id="decorationTotal">0</div>
                            <div style="color: #718096; font-size: 14px;">æ€»é¡¹ç›®æ•°</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: #48bb78;" id="decorationCompleted">0</div>
                            <div style="color: #718096; font-size: 14px;">å·²å®Œæˆ</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: #ed8936;" id="decorationInProgress">0</div>
                            <div style="color: #718096; font-size: 14px;">è¿›è¡Œä¸­</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 800; color: #f56565;" id="decorationPending">0</div>
                            <div style="color: #718096; font-size: 14px;">æœªå¼€å§‹</div>
                        </div>
                    </div>
                </div>
            </div>

            <table class="data-table" id="decorationTable">
                <thead>
                    <tr>
                        <th>é¡¹ç›®åç§°</th>
                        <th>ç±»å‹</th>
                        <th>åŒºåŸŸ</th>
                        <th>è§„æ ¼</th>
                        <th>æ•°é‡</th>
                        <th>å•ä»·</th>
                        <th>æ€»ä»·</th>
                        <th>æ‰¿åŒ…æ–¹</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="decorationTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #718096;">
                            æš‚æ— è£…ä¿®é¡¹ç›®æ•°æ®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ç‰©æ–™åº“å­˜ -->
        <div id="inventory" class="content-area section-inventory">
            <div class="section-header">
                <h2 class="section-title">ğŸ“¦ ç‰©æ–™åº“å­˜ç®¡ç†</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-warning" onclick="showInventoryModal()">
                        â• æ·»åŠ ç‰©æ–™
                    </button>
                    <button class="btn btn-info" onclick="showInventoryInModal()">
                        ğŸ“¥ å…¥åº“
                    </button>
                    <button class="btn btn-danger" onclick="showInventoryOutModal()">
                        ğŸ“¤ å‡ºåº“
                    </button>
                </div>
            </div>

            <!-- åº“å­˜é¢„è­¦ -->
            <div class="inventory-warning" id="inventoryWarning">
                <div class="warning-content">
                    <span>âš ï¸</span>
                    <span id="warningMessage"></span>
                </div>
            </div>

            <div style="margin-bottom: 20px; display: flex; gap: 15px;">
                <select id="inventoryCategoryFilter" class="form-control" style="width: 200px;" onchange="filterInventory()">
                    <option value="">æ‰€æœ‰ç‰©æ–™ç±»åˆ«</option>
                    <option value="æ´—æµ´ç”¨å“">æ´—æµ´ç”¨å“</option>
                    <option value="é¥®å“">é¥®å“</option>
                    <option value="å°åƒ">å°åƒ</option>
                    <option value="æ¸…æ´ç”¨å“">æ¸…æ´ç”¨å“</option>
                    <option value="åŠå…¬ç”¨å“">åŠå…¬ç”¨å“</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <input type="text" id="inventorySearch" class="form-control" style="width: 300px;" placeholder="æœç´¢ç‰©æ–™åç§°..." oninput="filterInventory()">
            </div>

            <table class="data-table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>ç‰©æ–™åç§°</th>
                        <th>ç±»åˆ«</th>
                        <th>è§„æ ¼</th>
                        <th>å•ä½</th>
                        <th>åº“å­˜æ•°é‡</th>
                        <th>æœ€ä½åº“å­˜</th>
                        <th>å•ä»·</th>
                        <th>åº“å­˜ä»·å€¼</th>
                        <th>ä¾›åº”å•†</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #718096;">
                            æš‚æ— ç‰©æ–™åº“å­˜æ•°æ®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æˆ¿é—´ç®¡ç† -->
        <div id="rooms" class="content-area section-rooms">
            <div class="section-header">
                <h2 class="section-title">ğŸšª æˆ¿é—´/åŒ…é—´ç®¡ç†</h2>
                <button class="btn btn-info" onclick="showRoomModal()">
                    â• æ·»åŠ æˆ¿é—´
                </button>
            </div>

            <!-- æˆ¿é—´çŠ¶æ€ç»Ÿè®¡ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #c6f6d5, #9ae6b4); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 800; color: #276749;" id="roomAvailable">0</div>
                    <div style="color: #276749; font-weight: 600;">ç©ºé—²</div>
                </div>
                <div style="background: linear-gradient(135deg, #fed7d7, #feb2b2); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 800; color: #9b2c2c;" id="roomOccupied">0</div>
                    <div style="color: #9b2c2c; font-weight: 600;">ä½¿ç”¨ä¸­</div>
                </div>
                <div style="background: linear-gradient(135deg, #fed7e2, #fbb6ce); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 800; color: #97266d;" id="roomCleaning">0</div>
                    <div style="color: #97266d; font-weight: 600;">æ¸…æ´ä¸­</div>
                </div>
                <div style="background: linear-gradient(135deg, #e2e8f0, #cbd5e0); padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 800; color: #4a5568;" id="roomMaintenance">0</div>
                    <div style="color: #4a5568; font-weight: 600;">ç»´ä¿®ä¸­</div>
                </div>
            </div>

            <div class="rooms-grid" id="roomsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                <!-- æˆ¿é—´å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div style="text-align: center; padding: 60px 20px; color: #718096; grid-column: 1 / -1;">
                    <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;">ğŸšª</div>
                    <p>æš‚æ— æˆ¿é—´æ•°æ®</p>
                    <p style="font-size: 14px; margin-top: 10px;">ç‚¹å‡»"æ·»åŠ æˆ¿é—´"æŒ‰é’®å¼€å§‹åˆ›å»º</p>
                </div>
            </div>
        </div>

        <!-- æˆæœ¬é¢„ç®— -->
        <div id="budget" class="content-area section-budget">
            <div class="section-header">
                <h2 class="section-title">ğŸ’° æˆæœ¬é¢„ç®—ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="showBudgetModal()">
                    â• æ·»åŠ é¢„ç®—é¡¹
                </button>
            </div>

            <!-- é¢„ç®—æ¦‚è§ˆ -->
            <div style="background: #f7fafc; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #4a5568;">é¢„ç®—æ‰§è¡Œæƒ…å†µ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 14px; color: #718096; margin-bottom: 10px;">æ€»é¢„ç®—</div>
                        <div style="font-size: 28px; font-weight: 800; color: #2d3748;" id="totalBudgetAmount">0 å…ƒ</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 14px; color: #718096; margin-bottom: 10px;">å®é™…æ”¯å‡º</div>
                        <div style="font-size: 28px; font-weight: 800; color: #f56565;" id="totalActualAmount">0 å…ƒ</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 14px; color: #718096; margin-bottom: 10px;">é¢„ç®—å·®å¼‚</div>
                        <div style="font-size: 28px; font-weight: 800; color: #48bb78;" id="totalVariance">0 å…ƒ</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 14px; color: #718096; margin-bottom: 10px;">æ‰§è¡Œç‡</div>
                        <div style="font-size: 28px; font-weight: 800; color: #667eea;" id="budgetExecutionRate">0%</div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px; display: flex; gap: 15px;">
                <select id="budgetCategoryFilter" class="form-control" style="width: 200px;" onchange="filterBudget()">
                    <option value="">æ‰€æœ‰é¢„ç®—ç±»åˆ«</option>
                    <option value="è®¾å¤‡">è®¾å¤‡</option>
                    <option value="è£…ä¿®">è£…ä¿®</option>
                    <option value="ç‰©æ–™">ç‰©æ–™</option>
                    <option value="äººå·¥">äººå·¥</option>
                    <option value="ç§Ÿé‡‘">ç§Ÿé‡‘</option>
                    <option value="æ°´ç”µ">æ°´ç”µ</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>

            <table class="data-table" id="budgetTable">
                <thead>
                    <tr>
                        <th>é¢„ç®—ç±»åˆ«</th>
                        <th>é¡¹ç›®åç§°</th>
                        <th>é¢„ç®—é‡‘é¢</th>
                        <th>å®é™…é‡‘é¢</th>
                        <th>å·®å¼‚</th>
                        <th>æ‰§è¡Œç‡</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #718096;">
                            æš‚æ— é¢„ç®—æ•°æ®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ”¶å…¥é¢„æµ‹ -->
        <div id="revenue" class="content-area section-revenue">
            <div class="section-header">
                <h2 class="section-title">ğŸ“ˆ æ”¶å…¥é¢„æµ‹åˆ†æ</h2>
                <button class="btn btn-success" onclick="showRevenueModal()">
                    â• æ·»åŠ é¢„æµ‹
                </button>
            </div>

            <!-- æ”¶å…¥é¢„æµ‹å›¾è¡¨ -->
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="chart-title">æœˆåº¦æ”¶å…¥é¢„æµ‹</div>
                    <select class="form-control" style="width: 200px;" onchange="loadRevenueData(this.value)">
                        <option value="6">æœ€è¿‘6ä¸ªæœˆ</option>
                        <option value="12">æœ€è¿‘12ä¸ªæœˆ</option>
                        <option value="24">æœ€è¿‘24ä¸ªæœˆ</option>
                    </select>
                </div>
                <canvas id="revenueForecastChart" height="300"></canvas>
            </div>

            <!-- æ”¶å…¥ç±»å‹åˆ†å¸ƒ -->
            <div class="chart-container">
                <div class="chart-title">æ”¶å…¥ç±»å‹åˆ†å¸ƒ</div>
                <canvas id="revenueTypeChart" height="250"></canvas>
            </div>

            <!-- è¯¦ç»†é¢„æµ‹è¡¨ -->
            <h3 style="margin: 30px 0 20px; color: #4a5568;">è¯¦ç»†é¢„æµ‹æ•°æ®</h3>
            <table class="data-table" id="revenueTable">
                <thead>
                    <tr>
                        <th>é¢„æµ‹æœˆä»½</th>
                        <th>æœåŠ¡ç±»å‹</th>
                        <th>å•ä»·(å…ƒ)</th>
                        <th>é¢„è®¡æœåŠ¡æ¬¡æ•°</th>
                        <th>é¢„è®¡æ”¶å…¥</th>
                        <th>ç´¯è®¡æ”¶å…¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="revenueTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #718096;">
                            æš‚æ— æ”¶å…¥é¢„æµ‹æ•°æ®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- å„ç§æ¨¡æ€æ¡† -->
    <!-- è®¾å¤‡ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ è®¾å¤‡</div>
            <form id="equipmentForm" onsubmit="saveEquipment(event)">
                <div class="form-grid">
                    <div class="form-group required">
                        <label for="equipmentName">è®¾å¤‡åç§°</label>
                        <input type="text" id="equipmentName" class="form-control" required>
                    </div>
                    <div class="form-group required">
                        <label for="equipmentType">è®¾å¤‡ç±»å‹</label>
                        <select id="equipmentType" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="è¶³æµ´è®¾å¤‡">è¶³æµ´è®¾å¤‡</option>
                            <option value="æŒ‰æ‘©è®¾å¤‡">æŒ‰æ‘©è®¾å¤‡</option>
                            <option value="æ°´å¤„ç†è®¾å¤‡">æ°´å¤„ç†è®¾å¤‡</option>
                            <option value="å®¶å…·">å®¶å…·</option>
                            <option value="ç”µå™¨">ç”µå™¨</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="specification">è§„æ ¼å‹å·</label>
                        <input type="text" id="specification" class="form-control">
                    </div>
                    <div class="form-group required">
                        <label for="quantity">æ•°é‡</label>
                        <input type="number" id="quantity" class="form-control" min="1" value="1" required>
                    </div>
                    <div class="form-group required">
                        <label for="unitPrice">å•ä»·(å…ƒ)</label>
                        <input type="number" id="unitPrice" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="purchaseDate">é‡‡è´­æ—¥æœŸ</label>
                        <input type="date" id="purchaseDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="supplier">ä¾›åº”å•†</label>
                        <input type="text" id="supplier" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="warrantyPeriod">ä¿ä¿®æœŸ(æœˆ)</label>
                        <input type="number" id="warrantyPeriod" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label for="status">çŠ¶æ€</label>
                        <select id="status" class="form-control">
                            <option value="æ­£å¸¸">æ­£å¸¸</option>
                            <option value="ç»´ä¿®">ç»´ä¿®</option>
                            <option value="æŠ¥åºŸ">æŠ¥åºŸ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">å­˜æ”¾ä½ç½®</label>
                        <input type="text" id="location" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label for="equipmentNotes">å¤‡æ³¨</label>
                    <textarea id="equipmentNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('equipmentModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è£…ä¿®ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="decorationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ è£…ä¿®é¡¹ç›®</div>
            <form id="decorationForm" onsubmit="saveDecoration(event)">
                <div class="form-grid">
                    <div class="form-group required">
                        <label for="itemName">é¡¹ç›®åç§°</label>
                        <input type="text" id="itemName" class="form-control" required>
                    </div>
                    <div class="form-group required">
                        <label for="itemType">è£…ä¿®ç±»å‹</label>
                        <select id="itemType" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="ç¡¬è£…">ç¡¬è£…</option>
                            <option value="è½¯è£…">è½¯è£…</option>
                            <option value="ç”µæ°”">ç”µæ°”</option>
                            <option value="ç®¡é“">ç®¡é“</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="area">åŒºåŸŸ</label>
                        <select id="area" class="form-control">
                            <option value="">è¯·é€‰æ‹©åŒºåŸŸ</option>
                            <option value="å¤§å ‚">å¤§å ‚</option>
                            <option value="æ™®é€šåŒ…é—´">æ™®é€šåŒ…é—´</option>
                            <option value="VIPåŒ…é—´">VIPåŒ…é—´</option>
                            <option value="èµ°å»Š">èµ°å»Š</option>
                            <option value="å«ç”Ÿé—´">å«ç”Ÿé—´</option>
                            <option value="å‘˜å·¥åŒº">å‘˜å·¥åŒº</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="decorationSpecification">è§„æ ¼è¦æ±‚</label>
                        <input type="text" id="decorationSpecification" class="form-control">
                    </div>
                    <div class="form-group required">
                        <label for="decorationUnit">å•ä½</label>
                        <input type="text" id="decorationUnit" class="form-control" value="é¡¹" required>
                    </div>
                    <div class="form-group required">
                        <label for="decorationQuantity">æ•°é‡</label>
                        <input type="number" id="decorationQuantity" class="form-control" min="1" step="0.01" value="1" required>
                    </div>
                    <div class="form-group required">
                        <label for="decorationUnitPrice">å•ä»·(å…ƒ)</label>
                        <input type="number" id="decorationUnitPrice" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="contractor">æ‰¿åŒ…æ–¹</label>
                        <input type="text" id="contractor" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="decorationStatus">çŠ¶æ€</label>
                        <select id="decorationStatus" class="form-control">
                            <option value="æœªå¼€å§‹">æœªå¼€å§‹</option>
                            <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="decorationNotes">å¤‡æ³¨</label>
                    <textarea id="decorationNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('decorationModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç‰©æ–™ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ ç‰©æ–™</div>
            <form id="inventoryForm" onsubmit="saveInventory(event)">
                <div class="form-grid">
                    <div class="form-group required">
                        <label for="inventoryItemName">ç‰©æ–™åç§°</label>
                        <input type="text" id="inventoryItemName" class="form-control" required>
                    </div>
                    <div class="form-group required">
                        <label for="inventoryCategory">ç‰©æ–™ç±»åˆ«</label>
                        <select id="inventoryCategory" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                            <option value="æ´—æµ´ç”¨å“">æ´—æµ´ç”¨å“</option>
                            <option value="é¥®å“">é¥®å“</option>
                            <option value="å°åƒ">å°åƒ</option>
                            <option value="æ¸…æ´ç”¨å“">æ¸…æ´ç”¨å“</option>
                            <option value="åŠå…¬ç”¨å“">åŠå…¬ç”¨å“</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inventorySpecification">è§„æ ¼</label>
                        <input type="text" id="inventorySpecification" class="form-control">
                    </div>
                    <div class="form-group required">
                        <label for="inventoryUnit">å•ä½</label>
                        <input type="text" id="inventoryUnit" class="form-control" value="ä»¶" required>
                    </div>
                    <div class="form-group required">
                        <label for="inventoryStockQuantity">åˆå§‹åº“å­˜æ•°é‡</label>
                        <input type="number" id="inventoryStockQuantity" class="form-control" min="0" step="0.01" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="inventoryMinQuantity">æœ€ä½åº“å­˜é‡</label>
                        <input type="number" id="inventoryMinQuantity" class="form-control" min="0" step="0.01" value="0">
                    </div>
                    <div class="form-group required">
                        <label for="inventoryUnitPrice">å•ä»·(å…ƒ)</label>
                        <input type="number" id="inventoryUnitPrice" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="inventorySupplier">ä¾›åº”å•†</label>
                        <input type="text" id="inventorySupplier" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="inventoryExpirationDate">ä¿è´¨æœŸè‡³</label>
                        <input type="date" id="inventoryExpirationDate" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label for="inventoryNotes">å¤‡æ³¨</label>
                    <textarea id="inventoryNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('inventoryModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å…¥åº“å‡ºåº“æ¨¡æ€æ¡† -->
    <div id="inventoryInOutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="inventoryInOutTitle">å…¥åº“æ“ä½œ</div>
            <form id="inventoryInOutForm" onsubmit="saveInventoryInOut(event)">
                <div class="form-group required">
                    <label for="inventoryItemSelect">é€‰æ‹©ç‰©æ–™</label>
                    <select id="inventoryItemSelect" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©ç‰©æ–™</option>
                    </select>
                </div>
                <div class="form-group required">
                    <label for="inventoryChangeAmount">æ•°é‡</label>
                    <input type="number" id="inventoryChangeAmount" class="form-control" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="inventoryChangeReason">åŸå› /å¤‡æ³¨</label>
                    <input type="text" id="inventoryChangeReason" class="form-control" placeholder="ä¾‹å¦‚ï¼šé‡‡è´­å…¥åº“ã€é¢†ç”¨å‡ºåº“ç­‰">
                </div>
                <input type="hidden" id="inventoryChangeType" value="in">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('inventoryInOutModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç¡®è®¤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æˆ¿é—´ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ æˆ¿é—´</div>
            <form id="roomForm" onsubmit="saveRoom(event)">
                <div class="form-grid">
                    <div class="form-group required">
                        <label for="roomNumber">æˆ¿é—´å·</label>
                        <input type="text" id="roomNumber" class="form-control" required>
                    </div>
                    <div class="form-group required">
                        <label for="roomType">æˆ¿é—´ç±»å‹</label>
                        <select id="roomType" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="æ™®é€š">æ™®é€šåŒ…é—´</option>
                            <option value="VIP">VIPåŒ…é—´</option>
                            <option value="è±ªå">è±ªååŒ…é—´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="roomCapacity">å¯å®¹çº³äººæ•°</label>
                        <input type="number" id="roomCapacity" class="form-control" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="roomArea">é¢ç§¯(å¹³æ–¹ç±³)</label>
                        <input type="number" id="roomArea" class="form-control" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="roomHourlyRate">å°æ—¶è´¹ç‡(å…ƒ)</label>
                        <input type="number" id="roomHourlyRate" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="roomStatus">çŠ¶æ€</label>
                        <select id="roomStatus" class="form-control">
                            <option value="ç©ºé—²">ç©ºé—²</option>
                            <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
                            <option value="æ¸…æ´ä¸­">æ¸…æ´ä¸­</option>
                            <option value="ç»´ä¿®ä¸­">ç»´ä¿®ä¸­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="roomEquipmentList">é…å¤‡è®¾å¤‡</label>
                        <input type="text" id="roomEquipmentList" class="form-control" placeholder="è®¾å¤‡åç§°ï¼Œç”¨é€—å·åˆ†éš”">
                    </div>
                </div>
                <div class="form-group">
                    <label for="roomNotes">å¤‡æ³¨</label>
                    <textarea id="roomNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('roomModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æˆæœ¬é¢„ç®—æ¨¡æ€æ¡† -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ é¢„ç®—é¡¹</div>
            <form id="budgetForm" onsubmit="saveBudget(event)">
                <div class="form-grid">
                    <div class="form-group required">
                        <label for="budgetCategory">é¢„ç®—ç±»åˆ«</label>
                        <select id="budgetCategory" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                            <option value="è®¾å¤‡">è®¾å¤‡</option>
                            <option value="è£…ä¿®">è£…ä¿®</option>
                            <option value="ç‰©æ–™">ç‰©æ–™</option>
                            <option value="äººå·¥">äººå·¥</option>
                            <option value="ç§Ÿé‡‘">ç§Ÿé‡‘</option>
                            <option value="æ°´ç”µ">æ°´ç”µ</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group required">
                        <label for="budgetItemName">é¡¹ç›®åç§°</label>
                        <input type="text" id="budgetItemName" class="form-control" required>
                    </div>
                    <div class="form-group required">
                        <label for="budgetAmount">é¢„ç®—é‡‘é¢(å…ƒ)</label>
                        <input type="number" id="budgetAmount" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="budgetActualAmount">å®é™…é‡‘é¢(å…ƒ)</label>
                        <input type="number" id="budgetActualAmount" class="form-control" min="0" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="budgetStatus">çŠ¶æ€</label>
                        <select id="budgetStatus" class="form-control">
                            <option value="é¢„ç®—ä¸­">é¢„ç®—ä¸­</option>
                            <option value="æ‰§è¡Œä¸­">æ‰§è¡Œä¸­</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                            <option value="è¶…æ”¯">è¶…æ”¯</option>
                            <option value="èŠ‚çº¦">èŠ‚çº¦</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="budgetNotes">å¤‡æ³¨</label>
                    <textarea id="budgetNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('budgetModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ”¶å…¥é¢„æµ‹æ¨¡æ€æ¡† -->
    <div id="revenueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ æ”¶å…¥é¢„æµ‹</div>
            <form id="revenueForm" onsubmit="saveRevenue(event)">
                <div class="form-grid">
                    <div class="form-group required">
                        <label for="revenueForecastMonth">é¢„æµ‹æœˆä»½</label>
                        <input type="month" id="revenueForecastMonth" class="form-control" required>
                    </div>
                    <div class="form-group required">
                        <label for="revenueForecastType">æœåŠ¡ç±»å‹</label>
                        <select id="revenueForecastType" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="è¶³æµ´">è¶³æµ´</option>
                            <option value="æŒ‰æ‘©">æŒ‰æ‘©</option>
                            <option value="SPA">SPA</option>
                            <option value="ä¼šå‘˜å¡">ä¼šå‘˜å¡</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group required">
                        <label for="revenueUnitPrice">å•ä»·(å…ƒ)</label>
                        <input type="number" id="revenueUnitPrice" class="form-control" min="0" step="1" required>
                    </div>
                    <div class="form-group required">
                        <label for="revenueExpectedQuantity">é¢„è®¡æœåŠ¡æ¬¡æ•°</label>
                        <input type="number" id="revenueExpectedQuantity" class="form-control" min="0" step="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="revenueNotes">å¤‡æ³¨</label>
                    <textarea id="revenueNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('revenueModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- å¼•å…¥Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let currentProjectId = null;
        let currentProjectData = null;
        let equipmentList = [];
        let decorationList = [];
        let inventoryList = [];
        let roomList = [];
        let budgetList = [];
        let revenueList = [];

        // å›¾è¡¨å®ä¾‹
        let costChart = null;
        let progressChart = null;
        let revenueChart = null;
        let revenueTypeChart = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAllProjects();
            initCharts();
        });

        // åŠ è½½æ‰€æœ‰é¡¹ç›®
        async function loadAllProjects() {
            try {
                const response = await fetch('/api/projects');
                if (!response.ok) throw new Error('åŠ è½½é¡¹ç›®å¤±è´¥');
                const projects = await response.json();

                const select = document.getElementById('projectSelect');
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} - ${getProjectStatus(project)}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                showMessage('åŠ è½½é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function getProjectStatus(project) {
            if (!project.total_investment || project.total_investment === 0) {
                return 'è§„åˆ’ä¸­';
            } else if (project.total_investment < 1000000) {
                return 'ç­¹å¤‡ä¸­';
            } else {
                return 'è¿è¥ä¸­';
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
            document.getElementById(tabName).classList.add('active');

            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.textContent.includes(getTabIcon(tabName))) {
                    tab.classList.add('active');
                }
            });

            // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
            if (currentProjectId) {
                loadTabData(tabName);
            }
        }

        function getTabIcon(tabName) {
            const icons = {
                'dashboard': 'ğŸ“Š',
                'equipment': 'ğŸ› ï¸',
                'decoration': 'ğŸ—ï¸',
                'inventory': 'ğŸ“¦',
                'rooms': 'ğŸšª',
                'budget': 'ğŸ’°',
                'revenue': 'ğŸ“ˆ'
            };
            return icons[tabName] || '';
        }

        // åŠ è½½é¡¹ç›®æ•°æ®
        async function loadProjectData(projectId) {
            if (!projectId) return;

            currentProjectId = projectId;
            showLoading();

            try {
                // åŠ è½½é¡¹ç›®è¯¦æƒ…
                const projectResponse = await fetch(`/api/project/${projectId}`);
                currentProjectData = await projectResponse.json();

                // æ›´æ–°é¡¹ç›®çŠ¶æ€æ˜¾ç¤º
                updateProjectStatus();

                // åŠ è½½æ‰€æœ‰æ•°æ®
                await Promise.all([
                    loadEquipment(),
                    loadDecoration(),
                    loadInventory(),
                    loadRooms(),
                    loadBudget(),
                    loadRevenue()
                ]);

                // æ›´æ–°ä»ªè¡¨æ¿
                updateDashboard();

                // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                updateCharts();

                showMessage('é¡¹ç›®æ•°æ®åŠ è½½æˆåŠŸ', 'success');

            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error);
                showMessage('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æ ‡ç­¾æ•°æ®
        async function loadTabData(tabName) {
            if (!currentProjectId) return;

            switch(tabName) {
                case 'equipment':
                    await loadEquipment();
                    break;
                case 'decoration':
                    await loadDecoration();
                    break;
                case 'inventory':
                    await loadInventory();
                    break;
                case 'rooms':
                    await loadRooms();
                    break;
                case 'budget':
                    await loadBudget();
                    break;
                case 'revenue':
                    await loadRevenue();
                    break;
            }
        }

        // åŠ è½½è®¾å¤‡æ•°æ®
        async function loadEquipment() {
            try {
                const response = await fetch(`/api/equipment/project/${currentProjectId}`);
                if (!response.ok) throw new Error('åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥');

                equipmentList = await response.json();
                renderEquipmentTable();

            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥:', error);
                equipmentList = [];
                renderEquipmentTable();
            }
        }

        // æ¸²æŸ“è®¾å¤‡è¡¨æ ¼
        function renderEquipmentTable() {
            const tbody = document.getElementById('equipmentTableBody');
            if (!tbody) return;

            const typeFilter = document.getElementById('equipmentTypeFilter').value;
            const statusFilter = document.getElementById('equipmentStatusFilter').value;
            const searchText = document.getElementById('equipmentSearch').value.toLowerCase();

            const filteredEquipment = equipmentList.filter(equipment => {
                if (typeFilter && equipment.equipment_type !== typeFilter) return false;
                if (statusFilter && equipment.status !== statusFilter) return false;
                if (searchText && !equipment.equipment_name.toLowerCase().includes(searchText)) return false;
                return true;
            });

            if (filteredEquipment.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #718096;">
                            ${equipmentList.length === 0 ? 'æš‚æ— è®¾å¤‡æ•°æ®' : 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡'}
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            let totalValue = 0;

            filteredEquipment.forEach(equipment => {
                const statusClass = equipment.status === 'æ­£å¸¸' ? 'tag-normal' :
                                 equipment.status === 'ç»´ä¿®' ? 'tag-maintenance' : 'tag-scrap';

                html += `
                    <tr>
                        <td>${equipment.equipment_name}</td>
                        <td>${equipment.equipment_type}</td>
                        <td>${equipment.specification || '-'}</td>
                        <td>${equipment.quantity}</td>
                        <td>${parseFloat(equipment.unit_price).toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${parseFloat(equipment.total_price).toLocaleString('zh-CN')}å…ƒ</td>
                        <td><span class="status-tag ${statusClass}">${equipment.status}</span></td>
                        <td>${equipment.location || '-'}</td>
                        <td>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #4299e1; color: white; margin-right: 5px;" onclick="editEquipment(${equipment.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #f56565; color: white;" onclick="deleteEquipment(${equipment.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;

                totalValue += parseFloat(equipment.total_price);
            });

            tbody.innerHTML = html;

            // æ›´æ–°ä»ªè¡¨æ¿æ•°æ®
            const totalEquipmentValue = equipmentList.reduce((sum, eq) => sum + parseFloat(eq.total_price), 0);
            document.getElementById('totalEquipmentValue').textContent = totalEquipmentValue.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('equipmentStatus').textContent = `${equipmentList.length}å°è®¾å¤‡`;
        }

        // è¿‡æ»¤è®¾å¤‡
        function filterEquipment() {
            renderEquipmentTable();
        }

        // æ˜¾ç¤ºè®¾å¤‡æ¨¡æ€æ¡†
        function showEquipmentModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // é‡ç½®è¡¨å•
            document.getElementById('equipmentForm').reset();
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('status').value = 'æ­£å¸¸';

            showModal('equipmentModal');
        }

        // ä¿å­˜è®¾å¤‡
async function saveEquipment(event) {
    event.preventDefault();

    // éªŒè¯å¿…å¡«å­—æ®µ
    const equipmentName = document.getElementById('equipmentName').value.trim();
    const equipmentType = document.getElementById('equipmentType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const unitPrice = parseFloat(document.getElementById('unitPrice').value);

    if (!equipmentName) {
        showMessage('è®¾å¤‡åç§°ä¸èƒ½ä¸ºç©º', 'error');
        return;
    }

    if (!equipmentType) {
        showMessage('è¯·é€‰æ‹©è®¾å¤‡ç±»å‹', 'error');
        return;
    }

    if (quantity <= 0 || isNaN(quantity)) {
        showMessage('æ•°é‡å¿…é¡»å¤§äº0', 'error');
        return;
    }

    if (unitPrice <= 0 || isNaN(unitPrice)) {
        showMessage('å•ä»·å¿…é¡»å¤§äº0', 'error');
        return;
    }

    const formData = {
        project_id: parseInt(currentProjectId), // ç¡®ä¿æ˜¯æ•°å­—
        equipment_name: equipmentName,
        equipment_type: equipmentType,
        specification: document.getElementById('specification').value.trim(),
        quantity: quantity,
        unit_price: unitPrice,
        purchase_date: document.getElementById('purchaseDate').value,
        supplier: document.getElementById('supplier').value.trim(),
        warranty_period: document.getElementById('warrantyPeriod').value ?
            parseInt(document.getElementById('warrantyPeriod').value) : null,
        status: document.getElementById('status').value,
        location: document.getElementById('location').value.trim(),
        notes: document.getElementById('equipmentNotes').value.trim()
    };

    showLoading();
    try {
        console.log('å‘é€è®¾å¤‡æ•°æ®:', formData);

        // ä½¿ç”¨ä¸saveTierç›¸åŒçš„è¯·æ±‚å¤´æ ¼å¼
        const response = await fetch(`/api/equipment/project/${currentProjectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        // ç›´æ¥å°è¯•è§£æJSON
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || result.message ||
                `è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }

        if (result.success) {
            showMessage('è®¾å¤‡ä¿å­˜æˆåŠŸ', 'success');
            hideModal('equipmentModal');
            await loadEquipment();
            updateDashboard();
        } else {
            throw new Error(result.error || result.message || 'ä¿å­˜è®¾å¤‡å¤±è´¥');
        }

    } catch (error) {
        console.error('ä¿å­˜è®¾å¤‡å¤±è´¥:', error);

        // æ›´ç®€æ´çš„é”™è¯¯ä¿¡æ¯
        let errorMessage = error.message;
        if (error.message.includes('latin-1') || error.message.includes('ordinal not in range')) {
            errorMessage = 'æœåŠ¡å™¨ç¼–ç é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
            // è¿™é‡Œå¯ä»¥æ·»åŠ é‡è¯•é€»è¾‘æˆ–ä½¿ç”¨å…¶ä»–æ–¹æ³•
        }

        showMessage('ä¿å­˜è®¾å¤‡å¤±è´¥: ' + errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

        // ç¼–è¾‘è®¾å¤‡
        function editEquipment(equipmentId) {
            const equipment = equipmentList.find(e => e.id == equipmentId);
            if (equipment) {
                // å¡«å……è¡¨å•
                document.getElementById('equipmentName').value = equipment.equipment_name;
                document.getElementById('equipmentType').value = equipment.equipment_type;
                document.getElementById('specification').value = equipment.specification || '';
                document.getElementById('quantity').value = equipment.quantity;
                document.getElementById('unitPrice').value = equipment.unit_price;
                document.getElementById('purchaseDate').value = equipment.purchase_date || '';
                document.getElementById('supplier').value = equipment.supplier || '';
                document.getElementById('warrantyPeriod').value = equipment.warranty_period || '';
                document.getElementById('status').value = equipment.status;
                document.getElementById('location').value = equipment.location || '';
                document.getElementById('equipmentNotes').value = equipment.notes || '';

                // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’Œè¡¨å•è¡Œä¸º
                document.querySelector('#equipmentModal .modal-header').textContent = 'ç¼–è¾‘è®¾å¤‡';
                const form = document.getElementById('equipmentForm');
                form.onsubmit = async function(event) {
                    event.preventDefault();
                    await updateEquipment(equipmentId, event);
                };

                showModal('equipmentModal');
            }
        }

        async function updateEquipment(equipmentId, event) {
            event.preventDefault();

            const formData = {
                equipment_name: document.getElementById('equipmentName').value,
                equipment_type: document.getElementById('equipmentType').value,
                specification: document.getElementById('specification').value,
                quantity: parseInt(document.getElementById('quantity').value),
                unit_price: parseFloat(document.getElementById('unitPrice').value),
                status: document.getElementById('status').value,
                location: document.getElementById('location').value,
                notes: document.getElementById('equipmentNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/equipment/${equipmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('æ›´æ–°è®¾å¤‡å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('è®¾å¤‡æ›´æ–°æˆåŠŸ', 'success');
                    hideModal('equipmentModal');
                    await loadEquipment();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'æ›´æ–°è®¾å¤‡å¤±è´¥');
                }

            } catch (error) {
                console.error('æ›´æ–°è®¾å¤‡å¤±è´¥:', error);
                showMessage('æ›´æ–°è®¾å¤‡å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤è®¾å¤‡
        async function deleteEquipment(equipmentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ')) return;

            showLoading();
            try {
                const response = await fetch(`/api/equipment/${equipmentId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('åˆ é™¤è®¾å¤‡å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('è®¾å¤‡åˆ é™¤æˆåŠŸ', 'success');
                    await loadEquipment();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'åˆ é™¤è®¾å¤‡å¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error);
                showMessage('åˆ é™¤è®¾å¤‡å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½è£…ä¿®æ•°æ®
        async function loadDecoration() {
            try {
                const response = await fetch(`/api/decoration/project/${currentProjectId}`);
                if (!response.ok) throw new Error('åŠ è½½è£…ä¿®æ•°æ®å¤±è´¥');

                decorationList = await response.json();
                renderDecorationTable();
                updateDecorationStats();

            } catch (error) {
                console.error('åŠ è½½è£…ä¿®æ•°æ®å¤±è´¥:', error);
                decorationList = [];
                renderDecorationTable();
            }
        }

        // æ¸²æŸ“è£…ä¿®è¡¨æ ¼
        function renderDecorationTable() {
            const tbody = document.getElementById('decorationTableBody');
            if (!tbody) return;

            const typeFilter = document.getElementById('decorationTypeFilter').value;
            const statusFilter = document.getElementById('decorationStatusFilter').value;

            const filteredDecoration = decorationList.filter(item => {
                if (typeFilter && item.item_type !== typeFilter) return false;
                if (statusFilter && item.status !== statusFilter) return false;
                return true;
            });

            if (filteredDecoration.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #718096;">
                            ${decorationList.length === 0 ? 'æš‚æ— è£…ä¿®é¡¹ç›®æ•°æ®' : 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®'}
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            let totalBudget = 0;

            filteredDecoration.forEach(item => {
                const statusClass = item.status === 'æœªå¼€å§‹' ? 'tag-pending' :
                                  item.status === 'è¿›è¡Œä¸­' ? 'tag-in-progress' : 'tag-completed';

                html += `
                    <tr>
                        <td>${item.item_name}</td>
                        <td>${item.item_type}</td>
                        <td>${item.area || '-'}</td>
                        <td>${item.specification || '-'}</td>
                        <td>${item.quantity}${item.unit}</td>
                        <td>${parseFloat(item.unit_price).toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${parseFloat(item.total_price).toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${item.contractor || '-'}</td>
                        <td><span class="status-tag ${statusClass}">${item.status}</span></td>
                        <td>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #4299e1; color: white; margin-right: 5px;" onclick="editDecoration(${item.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #f56565; color: white;" onclick="deleteDecoration(${item.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;

                totalBudget += parseFloat(item.total_price);
            });

            tbody.innerHTML = html;

            // æ›´æ–°ä»ªè¡¨æ¿æ•°æ®
            const totalDecorationBudget = decorationList.reduce((sum, item) => sum + parseFloat(item.total_price), 0);
            document.getElementById('totalDecorationBudget').textContent = totalDecorationBudget.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('decorationStatus').textContent = `${decorationList.length}é¡¹è£…ä¿®`;
        }

        // æ›´æ–°è£…ä¿®ç»Ÿè®¡
        function updateDecorationStats() {
            const total = decorationList.length;
            const completed = decorationList.filter(item => item.status === 'å·²å®Œæˆ').length;
            const inProgress = decorationList.filter(item => item.status === 'è¿›è¡Œä¸­').length;
            const pending = decorationList.filter(item => item.status === 'æœªå¼€å§‹').length;

            document.getElementById('decorationTotal').textContent = total;
            document.getElementById('decorationCompleted').textContent = completed;
            document.getElementById('decorationInProgress').textContent = inProgress;
            document.getElementById('decorationPending').textContent = pending;
        }

        // è¿‡æ»¤è£…ä¿®é¡¹ç›®
        function filterDecoration() {
            renderDecorationTable();
        }

        // æ˜¾ç¤ºè£…ä¿®æ¨¡æ€æ¡†
        function showDecorationModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // é‡ç½®è¡¨å•
            document.getElementById('decorationForm').reset();
            document.getElementById('decorationUnit').value = 'é¡¹';
            document.getElementById('decorationQuantity').value = 1;
            document.getElementById('decorationStatus').value = 'æœªå¼€å§‹';

            showModal('decorationModal');
        }

        // ä¿å­˜è£…ä¿®é¡¹ç›®
        async function saveDecoration(event) {
            event.preventDefault();

            const formData = {
                project_id: currentProjectId,
                item_name: document.getElementById('itemName').value,
                item_type: document.getElementById('itemType').value,
                area: document.getElementById('area').value,
                specification: document.getElementById('decorationSpecification').value,
                unit: document.getElementById('decorationUnit').value,
                quantity: parseFloat(document.getElementById('decorationQuantity').value),
                unit_price: parseFloat(document.getElementById('decorationUnitPrice').value),
                contractor: document.getElementById('contractor').value,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                status: document.getElementById('decorationStatus').value,
                notes: document.getElementById('decorationNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/decoration/project/${currentProjectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('ä¿å­˜è£…ä¿®é¡¹ç›®å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('è£…ä¿®é¡¹ç›®ä¿å­˜æˆåŠŸ', 'success');
                    hideModal('decorationModal');
                    await loadDecoration();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'ä¿å­˜è£…ä¿®é¡¹ç›®å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜è£…ä¿®é¡¹ç›®å¤±è´¥:', error);
                showMessage('ä¿å­˜è£…ä¿®é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¼–è¾‘è£…ä¿®é¡¹ç›®
        function editDecoration(itemId) {
            const item = decorationList.find(d => d.id == itemId);
            if (item) {
                // å¡«å……è¡¨å•
                document.getElementById('itemName').value = item.item_name;
                document.getElementById('itemType').value = item.item_type;
                document.getElementById('area').value = item.area || '';
                document.getElementById('decorationSpecification').value = item.specification || '';
                document.getElementById('decorationUnit').value = item.unit || 'é¡¹';
                document.getElementById('decorationQuantity').value = item.quantity;
                document.getElementById('decorationUnitPrice').value = item.unit_price;
                document.getElementById('contractor').value = item.contractor || '';
                document.getElementById('startDate').value = item.start_date || '';
                document.getElementById('endDate').value = item.end_date || '';
                document.getElementById('decorationStatus').value = item.status;
                document.getElementById('decorationNotes').value = item.notes || '';

                // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’Œè¡¨å•è¡Œä¸º
                document.querySelector('#decorationModal .modal-header').textContent = 'ç¼–è¾‘è£…ä¿®é¡¹ç›®';
                const form = document.getElementById('decorationForm');
                form.onsubmit = async function(event) {
                    event.preventDefault();
                    await updateDecoration(itemId, event);
                };

                showModal('decorationModal');
            }
        }

        async function updateDecoration(itemId, event) {
            event.preventDefault();

            const formData = {
                item_name: document.getElementById('itemName').value,
                item_type: document.getElementById('itemType').value,
                area: document.getElementById('area').value,
                specification: document.getElementById('decorationSpecification').value,
                unit: document.getElementById('decorationUnit').value,
                quantity: parseFloat(document.getElementById('decorationQuantity').value),
                unit_price: parseFloat(document.getElementById('decorationUnitPrice').value),
                contractor: document.getElementById('contractor').value,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                status: document.getElementById('decorationStatus').value,
                notes: document.getElementById('decorationNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/decoration/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('æ›´æ–°è£…ä¿®é¡¹ç›®å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('è£…ä¿®é¡¹ç›®æ›´æ–°æˆåŠŸ', 'success');
                    hideModal('decorationModal');
                    await loadDecoration();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'æ›´æ–°è£…ä¿®é¡¹ç›®å¤±è´¥');
                }

            } catch (error) {
                console.error('æ›´æ–°è£…ä¿®é¡¹ç›®å¤±è´¥:', error);
                showMessage('æ›´æ–°è£…ä¿®é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤è£…ä¿®é¡¹ç›®
        async function deleteDecoration(itemId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè£…ä¿®é¡¹ç›®å—ï¼Ÿ')) return;

            showLoading();
            try {
                // è¿™é‡Œéœ€è¦å®ç°åˆ é™¤è£…ä¿®é¡¹ç›®çš„API
                // const response = await fetch(`/api/decoration/${itemId}`, {
                //     method: 'DELETE'
                // });

                // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                await new Promise(resolve => setTimeout(resolve, 500));

                showMessage('è£…ä¿®é¡¹ç›®åˆ é™¤æˆåŠŸ', 'success');
                decorationList = decorationList.filter(item => item.id !== itemId);
                renderDecorationTable();
                updateDecorationStats();
                updateDashboard();

            } catch (error) {
                console.error('åˆ é™¤è£…ä¿®é¡¹ç›®å¤±è´¥:', error);
                showMessage('åˆ é™¤è£…ä¿®é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½ç‰©æ–™æ•°æ®
        async function loadInventory() {
            try {
                const response = await fetch(`/api/inventory/project/${currentProjectId}`);
                if (!response.ok) throw new Error('åŠ è½½ç‰©æ–™æ•°æ®å¤±è´¥');

                inventoryList = await response.json();
                renderInventoryTable();
                checkInventoryWarning();

            } catch (error) {
                console.error('åŠ è½½ç‰©æ–™æ•°æ®å¤±è´¥:', error);
                inventoryList = [];
                renderInventoryTable();
            }
        }

        // æ¸²æŸ“ç‰©æ–™è¡¨æ ¼
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;

            const categoryFilter = document.getElementById('inventoryCategoryFilter').value;
            const searchText = document.getElementById('inventorySearch').value.toLowerCase();

            const filteredInventory = inventoryList.filter(item => {
                if (categoryFilter && item.category !== categoryFilter) return false;
                if (searchText && !item.item_name.toLowerCase().includes(searchText)) return false;
                return true;
            });

            if (filteredInventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #718096;">
                            ${inventoryList.length === 0 ? 'æš‚æ— ç‰©æ–™åº“å­˜æ•°æ®' : 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç‰©æ–™'}
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            let totalValue = 0;

            filteredInventory.forEach(item => {
                const stockValue = parseFloat(item.stock_quantity) * parseFloat(item.unit_price);
                const isLowStock = item.stock_quantity <= item.min_quantity;

                html += `
                    <tr style="${isLowStock ? 'background-color: #fff5f5;' : ''}">
                        <td>${item.item_name}</td>
                        <td>${item.category}</td>
                        <td>${item.specification || '-'}</td>
                        <td>${item.unit}</td>
                        <td style="font-weight: ${isLowStock ? 'bold' : 'normal'}; color: ${isLowStock ? '#f56565' : 'inherit'}">
                            ${parseFloat(item.stock_quantity).toLocaleString('zh-CN')}
                            ${isLowStock ? ' âš ï¸' : ''}
                        </td>
                        <td>${parseFloat(item.min_quantity).toLocaleString('zh-CN')}</td>
                        <td>${parseFloat(item.unit_price).toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${stockValue.toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${item.supplier || '-'}</td>
                        <td>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #4299e1; color: white; margin-right: 5px;" onclick="editInventory(${item.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #48bb78; color: white; margin-right: 5px;" onclick="quickIn(${item.id})">å…¥åº“</button>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #ed8936; color: white;" onclick="quickOut(${item.id})">å‡ºåº“</button>
                        </td>
                    </tr>
                `;

                totalValue += stockValue;
            });

            tbody.innerHTML = html;

            // æ›´æ–°ä»ªè¡¨æ¿æ•°æ®
            document.getElementById('totalInventoryValue').textContent = totalValue.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('inventoryStatus').textContent = `${inventoryList.length}ç§ç‰©æ–™`;
        }

        // æ£€æŸ¥åº“å­˜é¢„è­¦
        function checkInventoryWarning() {
            const lowStockItems = inventoryList.filter(item =>
                item.min_quantity > 0 && item.stock_quantity <= item.min_quantity
            );

            const warningElement = document.getElementById('inventoryWarning');
            const messageElement = document.getElementById('warningMessage');

            if (lowStockItems.length > 0) {
                const itemNames = lowStockItems.map(item => item.item_name).join('ã€');
                messageElement.textContent = `è­¦å‘Šï¼šä»¥ä¸‹ç‰©æ–™åº“å­˜ä¸è¶³ï¼š${itemNames}ï¼Œè¯·åŠæ—¶è¡¥å……ï¼`;
                warningElement.style.display = 'block';
            } else {
                warningElement.style.display = 'none';
            }
        }

        // è¿‡æ»¤ç‰©æ–™
        function filterInventory() {
            renderInventoryTable();
        }

        // æ˜¾ç¤ºç‰©æ–™æ¨¡æ€æ¡†
        function showInventoryModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // é‡ç½®è¡¨å•
            document.getElementById('inventoryForm').reset();
            document.getElementById('inventoryUnit').value = 'ä»¶';
            document.getElementById('inventoryStockQuantity').value = 0;
            document.getElementById('inventoryMinQuantity').value = 0;

            showModal('inventoryModal');
        }

        // ä¿å­˜ç‰©æ–™
        async function saveInventory(event) {
            event.preventDefault();

            const formData = {
                project_id: currentProjectId,
                item_name: document.getElementById('inventoryItemName').value,
                category: document.getElementById('inventoryCategory').value,
                specification: document.getElementById('inventorySpecification').value,
                unit: document.getElementById('inventoryUnit').value,
                stock_quantity: parseFloat(document.getElementById('inventoryStockQuantity').value),
                min_quantity: parseFloat(document.getElementById('inventoryMinQuantity').value),
                unit_price: parseFloat(document.getElementById('inventoryUnitPrice').value),
                supplier: document.getElementById('inventorySupplier').value,
                last_purchase_date: new Date().toISOString().split('T')[0],
                expiration_date: document.getElementById('inventoryExpirationDate').value || null,
                notes: document.getElementById('inventoryNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/inventory/project/${currentProjectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('ä¿å­˜ç‰©æ–™å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('ç‰©æ–™ä¿å­˜æˆåŠŸ', 'success');
                    hideModal('inventoryModal');
                    await loadInventory();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'ä¿å­˜ç‰©æ–™å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜ç‰©æ–™å¤±è´¥:', error);
                showMessage('ä¿å­˜ç‰©æ–™å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºå…¥åº“æ¨¡æ€æ¡†
        function showInventoryInModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            const select = document.getElementById('inventoryItemSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ç‰©æ–™</option>';

            inventoryList.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.item_name} (å½“å‰åº“å­˜: ${item.stock_quantity}${item.unit})`;
                select.appendChild(option);
            });

            document.getElementById('inventoryInOutTitle').textContent = 'å…¥åº“æ“ä½œ';
            document.getElementById('inventoryChangeType').value = 'in';

            showModal('inventoryInOutModal');
        }

        // æ˜¾ç¤ºå‡ºåº“æ¨¡æ€æ¡†
        function showInventoryOutModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            const select = document.getElementById('inventoryItemSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ç‰©æ–™</option>';

            inventoryList.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.item_name} (å½“å‰åº“å­˜: ${item.stock_quantity}${item.unit})`;
                select.appendChild(option);
            });

            document.getElementById('inventoryInOutTitle').textContent = 'å‡ºåº“æ“ä½œ';
            document.getElementById('inventoryChangeType').value = 'out';

            showModal('inventoryInOutModal');
        }

        // å¿«é€Ÿå…¥åº“
        function quickIn(inventoryId) {
            const item = inventoryList.find(i => i.id == inventoryId);
            if (item) {
                const select = document.getElementById('inventoryItemSelect');
                select.innerHTML = '';
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.item_name} (å½“å‰åº“å­˜: ${item.stock_quantity}${item.unit})`;
                select.appendChild(option);

                document.getElementById('inventoryInOutTitle').textContent = 'å…¥åº“æ“ä½œ';
                document.getElementById('inventoryChangeType').value = 'in';
                document.getElementById('inventoryChangeAmount').value = '';

                showModal('inventoryInOutModal');
            }
        }

        // å¿«é€Ÿå‡ºåº“
        function quickOut(inventoryId) {
            const item = inventoryList.find(i => i.id == inventoryId);
            if (item) {
                const select = document.getElementById('inventoryItemSelect');
                select.innerHTML = '';
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.item_name} (å½“å‰åº“å­˜: ${item.stock_quantity}${item.unit})`;
                select.appendChild(option);

                document.getElementById('inventoryInOutTitle').textContent = 'å‡ºåº“æ“ä½œ';
                document.getElementById('inventoryChangeType').value = 'out';
                document.getElementById('inventoryChangeAmount').value = '';

                showModal('inventoryInOutModal');
            }
        }

        // ä¿å­˜å…¥åº“å‡ºåº“æ“ä½œ
        async function saveInventoryInOut(event) {
            event.preventDefault();

            const inventoryId = document.getElementById('inventoryItemSelect').value;
            const changeAmount = parseFloat(document.getElementById('inventoryChangeAmount').value);
            const changeType = document.getElementById('inventoryChangeType').value;

            if (!inventoryId) {
                showMessage('è¯·é€‰æ‹©ç‰©æ–™', 'error');
                return;
            }

            if (changeAmount <= 0) {
                showMessage('æ•°é‡å¿…é¡»å¤§äº0', 'error');
                return;
            }

            const item = inventoryList.find(i => i.id == inventoryId);
            if (changeType === 'out' && item.stock_quantity < changeAmount) {
                showMessage(`åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ä¸º${item.stock_quantity}${item.unit}`, 'error');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/inventory/update/${inventoryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        change_amount: changeAmount,
                        change_type: changeType
                    })
                });

                if (!response.ok) throw new Error('åº“å­˜æ“ä½œå¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage(`${changeType === 'in' ? 'å…¥åº“' : 'å‡ºåº“'}æ“ä½œæˆåŠŸ`, 'success');
                    hideModal('inventoryInOutModal');
                    await loadInventory();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'åº“å­˜æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('åº“å­˜æ“ä½œå¤±è´¥:', error);
                showMessage('åº“å­˜æ“ä½œå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¼–è¾‘ç‰©æ–™
        function editInventory(inventoryId) {
            const item = inventoryList.find(i => i.id == inventoryId);
            if (item) {
                // å¡«å……è¡¨å•
                document.getElementById('inventoryItemName').value = item.item_name;
                document.getElementById('inventoryCategory').value = item.category;
                document.getElementById('inventorySpecification').value = item.specification || '';
                document.getElementById('inventoryUnit').value = item.unit || 'ä»¶';
                document.getElementById('inventoryStockQuantity').value = item.stock_quantity;
                document.getElementById('inventoryMinQuantity').value = item.min_quantity;
                document.getElementById('inventoryUnitPrice').value = item.unit_price;
                document.getElementById('inventorySupplier').value = item.supplier || '';
                document.getElementById('inventoryExpirationDate').value = item.expiration_date || '';
                document.getElementById('inventoryNotes').value = item.notes || '';

                // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’Œè¡¨å•è¡Œä¸º
                document.querySelector('#inventoryModal .modal-header').textContent = 'ç¼–è¾‘ç‰©æ–™';
                const form = document.getElementById('inventoryForm');
                form.onsubmit = async function(event) {
                    event.preventDefault();
                    await updateInventory(inventoryId, event);
                };

                showModal('inventoryModal');
            }
        }

        async function updateInventory(inventoryId, event) {
            event.preventDefault();

            const formData = {
                item_name: document.getElementById('inventoryItemName').value,
                category: document.getElementById('inventoryCategory').value,
                specification: document.getElementById('inventorySpecification').value,
                unit: document.getElementById('inventoryUnit').value,
                stock_quantity: parseFloat(document.getElementById('inventoryStockQuantity').value),
                min_quantity: parseFloat(document.getElementById('inventoryMinQuantity').value),
                unit_price: parseFloat(document.getElementById('inventoryUnitPrice').value),
                supplier: document.getElementById('inventorySupplier').value,
                expiration_date: document.getElementById('inventoryExpirationDate').value || null,
                notes: document.getElementById('inventoryNotes').value
            };

            showLoading();
            try {
                // è¿™é‡Œéœ€è¦å®ç°æ›´æ–°ç‰©æ–™çš„API
                await new Promise(resolve => setTimeout(resolve, 500));

                showMessage('ç‰©æ–™æ›´æ–°æˆåŠŸ', 'success');
                hideModal('inventoryModal');

                // æ›´æ–°æœ¬åœ°æ•°æ®
                const index = inventoryList.findIndex(i => i.id == inventoryId);
                if (index !== -1) {
                    inventoryList[index] = { ...inventoryList[index], ...formData };
                }

                renderInventoryTable();
                checkInventoryWarning();
                updateDashboard();

            } catch (error) {
                console.error('æ›´æ–°ç‰©æ–™å¤±è´¥:', error);
                showMessage('æ›´æ–°ç‰©æ–™å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æˆ¿é—´æ•°æ®
        async function loadRooms() {
            try {
                const response = await fetch(`/api/rooms/project/${currentProjectId}`);
                if (!response.ok) throw new Error('åŠ è½½æˆ¿é—´æ•°æ®å¤±è´¥');

                roomList = await response.json();
                renderRoomsGrid();
                updateRoomStats();

            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´æ•°æ®å¤±è´¥:', error);
                roomList = [];
                renderRoomsGrid();
            }
        }

        // æ¸²æŸ“æˆ¿é—´ç½‘æ ¼
        function renderRoomsGrid() {
            const grid = document.getElementById('roomsGrid');
            if (!grid) return;

            if (roomList.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #718096; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;">ğŸšª</div>
                        <p>æš‚æ— æˆ¿é—´æ•°æ®</p>
                        <p style="font-size: 14px; margin-top: 10px;">ç‚¹å‡»"æ·»åŠ æˆ¿é—´"æŒ‰é’®å¼€å§‹åˆ›å»º</p>
                    </div>
                `;
                return;
            }

            let html = '';

            roomList.forEach(room => {
                const statusClass = getRoomStatusClass(room.status);
                const typeClass = getRoomTypeClass(room.room_type);

                html += `
                    <div class="room-card ${statusClass}">
                        <div class="room-header">
                            <div class="room-title">${room.room_number}</div>
                            <div class="room-type ${typeClass}">${room.room_type}</div>
                        </div>

                        <div class="room-details">
                            <div class="room-detail-item">
                                <span class="room-detail-label">å¯å®¹çº³äººæ•°:</span>
                                <span class="room-detail-value">${room.capacity}äºº</span>
                            </div>
                            <div class="room-detail-item">
                                <span class="room-detail-label">é¢ç§¯:</span>
                                <span class="room-detail-value">${room.area}ã¡</span>
                            </div>
                            <div class="room-detail-item">
                                <span class="room-detail-label">å°æ—¶è´¹ç‡:</span>
                                <span class="room-detail-value">${room.hourly_rate}å…ƒ</span>
                            </div>
                        </div>

                        <div class="room-status" style="${getRoomStatusStyle(room.status)}">
                            ${room.status}
                        </div>

                        <div class="room-actions">
                            <button class="btn btn-sm" style="flex: 1; background: #4299e1; color: white;" onclick="changeRoomStatus(${room.id}, '${room.status}')">
                                æ›´æ–°çŠ¶æ€
                            </button>
                            <button class="btn btn-sm" style="flex: 1; background: #f56565; color: white;" onclick="deleteRoom(${room.id})">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function getRoomStatusClass(status) {
            switch(status) {
                case 'ç©ºé—²': return 'available';
                case 'ä½¿ç”¨ä¸­': return 'occupied';
                case 'æ¸…æ´ä¸­': return 'cleaning';
                case 'ç»´ä¿®ä¸­': return 'maintenance';
                default: return '';
            }
        }

        function getRoomTypeClass(type) {
            switch(type) {
                case 'VIP': return 'vip';
                case 'è±ªå': return 'luxury';
                default: return 'normal';
            }
        }

        function getRoomStatusStyle(status) {
            const styles = {
                'ç©ºé—²': 'background: linear-gradient(135deg, #c6f6d5, #9ae6b4); color: #276749;',
                'ä½¿ç”¨ä¸­': 'background: linear-gradient(135deg, #fed7d7, #feb2b2); color: #9b2c2c;',
                'æ¸…æ´ä¸­': 'background: linear-gradient(135deg, #fed7e2, #fbb6ce); color: #97266d;',
                'ç»´ä¿®ä¸­': 'background: linear-gradient(135deg, #e2e8f0, #cbd5e0); color: #4a5568;'
            };
            return styles[status] || '';
        }

        // æ›´æ–°æˆ¿é—´ç»Ÿè®¡
        function updateRoomStats() {
            const available = roomList.filter(room => room.status === 'ç©ºé—²').length;
            const occupied = roomList.filter(room => room.status === 'ä½¿ç”¨ä¸­').length;
            const cleaning = roomList.filter(room => room.status === 'æ¸…æ´ä¸­').length;
            const maintenance = roomList.filter(room => room.status === 'ç»´ä¿®ä¸­').length;

            document.getElementById('roomAvailable').textContent = available;
            document.getElementById('roomOccupied').textContent = occupied;
            document.getElementById('roomCleaning').textContent = cleaning;
            document.getElementById('roomMaintenance').textContent = maintenance;
        }

        // æ˜¾ç¤ºæˆ¿é—´æ¨¡æ€æ¡†
        function showRoomModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // é‡ç½®è¡¨å•
            document.getElementById('roomForm').reset();
            document.getElementById('roomCapacity').value = 1;
            document.getElementById('roomStatus').value = 'ç©ºé—²';

            showModal('roomModal');
        }

        // ä¿å­˜æˆ¿é—´
        async function saveRoom(event) {
            event.preventDefault();

            const formData = {
                project_id: currentProjectId,
                room_number: document.getElementById('roomNumber').value,
                room_type: document.getElementById('roomType').value,
                capacity: parseInt(document.getElementById('roomCapacity').value),
                area: parseFloat(document.getElementById('roomArea').value) || 0,
                hourly_rate: parseFloat(document.getElementById('roomHourlyRate').value) || 0,
                status: document.getElementById('roomStatus').value,
                equipment_list: document.getElementById('roomEquipmentList').value,
                notes: document.getElementById('roomNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/rooms/project/${currentProjectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('ä¿å­˜æˆ¿é—´å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('æˆ¿é—´ä¿å­˜æˆåŠŸ', 'success');
                    hideModal('roomModal');
                    await loadRooms();
                } else {
                    throw new Error(result.error || 'ä¿å­˜æˆ¿é—´å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜æˆ¿é—´å¤±è´¥:', error);
                showMessage('ä¿å­˜æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ›´æ–°æˆ¿é—´çŠ¶æ€
        async function changeRoomStatus(roomId, currentStatus) {
            const statusMap = {
                'ç©ºé—²': 'ä½¿ç”¨ä¸­',
                'ä½¿ç”¨ä¸­': 'æ¸…æ´ä¸­',
                'æ¸…æ´ä¸­': 'ç©ºé—²',
                'ç»´ä¿®ä¸­': 'ç©ºé—²'
            };

            const newStatus = statusMap[currentStatus] || 'ç©ºé—²';

            if (!confirm(`ç¡®å®šè¦å°†æˆ¿é—´çŠ¶æ€ä»"${currentStatus}"æ”¹ä¸º"${newStatus}"å—ï¼Ÿ`)) return;

            showLoading();
            try {
                const response = await fetch(`/api/rooms/update-status/${roomId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });

                if (!response.ok) throw new Error('æ›´æ–°æˆ¿é—´çŠ¶æ€å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('æˆ¿é—´çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
                    await loadRooms();
                } else {
                    throw new Error(result.error || 'æ›´æ–°æˆ¿é—´çŠ¶æ€å¤±è´¥');
                }

            } catch (error) {
                console.error('æ›´æ–°æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
                showMessage('æ›´æ–°æˆ¿é—´çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤æˆ¿é—´
        async function deleteRoom(roomId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆ¿é—´å—ï¼Ÿ')) return;

            showLoading();
            try {
                // è¿™é‡Œéœ€è¦å®ç°åˆ é™¤æˆ¿é—´çš„API
                // const response = await fetch(`/api/rooms/${roomId}`, {
                //     method: 'DELETE'
                // });

                // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                await new Promise(resolve => setTimeout(resolve, 500));

                showMessage('æˆ¿é—´åˆ é™¤æˆåŠŸ', 'success');
                roomList = roomList.filter(room => room.id !== roomId);
                renderRoomsGrid();
                updateRoomStats();

            } catch (error) {
                console.error('åˆ é™¤æˆ¿é—´å¤±è´¥:', error);
                showMessage('åˆ é™¤æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½é¢„ç®—æ•°æ®
        async function loadBudget() {
            try {
                const response = await fetch(`/api/budget/project/${currentProjectId}`);
                if (!response.ok) throw new Error('åŠ è½½é¢„ç®—æ•°æ®å¤±è´¥');

                budgetList = await response.json();
                renderBudgetTable();
                updateBudgetStats();

            } catch (error) {
                console.error('åŠ è½½é¢„ç®—æ•°æ®å¤±è´¥:', error);
                budgetList = [];
                renderBudgetTable();
            }
        }

                // æ¸²æŸ“é¢„ç®—è¡¨æ ¼
        function renderBudgetTable() {
            const tbody = document.getElementById('budgetTableBody');
            if (!tbody) return;

            const categoryFilter = document.getElementById('budgetCategoryFilter').value;

            const filteredBudget = budgetList.filter(item => {
                if (categoryFilter && item.category !== categoryFilter) return false;
                return true;
            });

            if (filteredBudget.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #718096;">
                            ${budgetList.length === 0 ? 'æš‚æ— é¢„ç®—æ•°æ®' : 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¢„ç®—'}
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            filteredBudget.forEach(item => {
                const budgetAmount = parseFloat(item.budget_amount);
                const actualAmount = parseFloat(item.actual_amount);
                const variance = budgetAmount - actualAmount;
                const executionRate = budgetAmount > 0 ? ((actualAmount / budgetAmount) * 100).toFixed(1) : 0;
                const varianceClass = variance >= 0 ? 'change-positive' : 'change-negative';
                const statusClass = getBudgetStatusClass(item.status);

                html += `
                    <tr>
                        <td>${item.category}</td>
                        <td>${item.item_name}</td>
                        <td>${budgetAmount.toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${actualAmount.toLocaleString('zh-CN')}å…ƒ</td>
                        <td><span class="${varianceClass}">${variance.toLocaleString('zh-CN')}å…ƒ</span></td>
                        <td>${executionRate}%</td>
                        <td><span class="status-tag ${statusClass}">${item.status}</span></td>
                        <td>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #4299e1; color: white; margin-right: 5px;" onclick="editBudget(${item.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #f56565; color: white;" onclick="deleteBudget(${item.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function getBudgetStatusClass(status) {
            switch(status) {
                case 'é¢„ç®—ä¸­': return 'tag-pending';
                case 'æ‰§è¡Œä¸­': return 'tag-in-progress';
                case 'å·²å®Œæˆ': return 'tag-completed';
                case 'è¶…æ”¯': return 'tag-maintenance';
                case 'èŠ‚çº¦': return 'tag-normal';
                default: return 'tag-normal';
            }
        }

        // æ›´æ–°é¢„ç®—ç»Ÿè®¡
        function updateBudgetStats() {
            const totalBudget = budgetList.reduce((sum, item) => sum + parseFloat(item.budget_amount), 0);
            const totalActual = budgetList.reduce((sum, item) => sum + parseFloat(item.actual_amount), 0);
            const totalVariance = totalBudget - totalActual;
            const executionRate = totalBudget > 0 ? ((totalActual / totalBudget) * 100).toFixed(1) : 0;

            document.getElementById('totalBudgetAmount').textContent = totalBudget.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('totalActualAmount').textContent = totalActual.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('totalVariance').textContent = totalVariance.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('budgetExecutionRate').textContent = executionRate + '%';

            // æ›´æ–°ä»ªè¡¨æ¿
            document.getElementById('totalCostBudget').textContent = totalBudget.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('budgetStatus').textContent = `${budgetList.length}é¡¹é¢„ç®—`;
        }

        // è¿‡æ»¤é¢„ç®—
        function filterBudget() {
            renderBudgetTable();
        }

        // æ˜¾ç¤ºé¢„ç®—æ¨¡æ€æ¡†
        function showBudgetModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // é‡ç½®è¡¨å•
            document.getElementById('budgetForm').reset();
            document.getElementById('budgetActualAmount').value = 0;
            document.getElementById('budgetStatus').value = 'é¢„ç®—ä¸­';

            showModal('budgetModal');
        }

        // ä¿å­˜é¢„ç®—
        async function saveBudget(event) {
            event.preventDefault();

            const formData = {
                project_id: currentProjectId,
                category: document.getElementById('budgetCategory').value,
                item_name: document.getElementById('budgetItemName').value,
                budget_amount: parseFloat(document.getElementById('budgetAmount').value),
                actual_amount: parseFloat(document.getElementById('budgetActualAmount').value),
                status: document.getElementById('budgetStatus').value,
                notes: document.getElementById('budgetNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/budget/project/${currentProjectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('ä¿å­˜é¢„ç®—å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('é¢„ç®—ä¿å­˜æˆåŠŸ', 'success');
                    hideModal('budgetModal');
                    await loadBudget();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'ä¿å­˜é¢„ç®—å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜é¢„ç®—å¤±è´¥:', error);
                showMessage('ä¿å­˜é¢„ç®—å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¼–è¾‘é¢„ç®—
        function editBudget(budgetId) {
            const item = budgetList.find(b => b.id == budgetId);
            if (item) {
                // å¡«å……è¡¨å•
                document.getElementById('budgetCategory').value = item.category;
                document.getElementById('budgetItemName').value = item.item_name;
                document.getElementById('budgetAmount').value = item.budget_amount;
                document.getElementById('budgetActualAmount').value = item.actual_amount;
                document.getElementById('budgetStatus').value = item.status;
                document.getElementById('budgetNotes').value = item.notes || '';

                // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’Œè¡¨å•è¡Œä¸º
                document.querySelector('#budgetModal .modal-header').textContent = 'ç¼–è¾‘é¢„ç®—é¡¹';
                const form = document.getElementById('budgetForm');
                form.onsubmit = async function(event) {
                    event.preventDefault();
                    await updateBudget(budgetId, event);
                };

                showModal('budgetModal');
            }
        }

        async function updateBudget(budgetId, event) {
            event.preventDefault();

            const formData = {
                category: document.getElementById('budgetCategory').value,
                item_name: document.getElementById('budgetItemName').value,
                budget_amount: parseFloat(document.getElementById('budgetAmount').value),
                actual_amount: parseFloat(document.getElementById('budgetActualAmount').value),
                status: document.getElementById('budgetStatus').value,
                notes: document.getElementById('budgetNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/budget/${budgetId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('æ›´æ–°é¢„ç®—å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('é¢„ç®—æ›´æ–°æˆåŠŸ', 'success');
                    hideModal('budgetModal');
                    await loadBudget();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'æ›´æ–°é¢„ç®—å¤±è´¥');
                }

            } catch (error) {
                console.error('æ›´æ–°é¢„ç®—å¤±è´¥:', error);
                showMessage('æ›´æ–°é¢„ç®—å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤é¢„ç®—
        async function deleteBudget(budgetId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„ç®—é¡¹å—ï¼Ÿ')) return;

            showLoading();
            try {
                const response = await fetch(`/api/budget/${budgetId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('åˆ é™¤é¢„ç®—å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('é¢„ç®—åˆ é™¤æˆåŠŸ', 'success');
                    await loadBudget();
                    updateDashboard();
                } else {
                    throw new Error(result.error || 'åˆ é™¤é¢„ç®—å¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ é™¤é¢„ç®—å¤±è´¥:', error);
                showMessage('åˆ é™¤é¢„ç®—å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æ”¶å…¥é¢„æµ‹æ•°æ®
        async function loadRevenue() {
            try {
                const response = await fetch(`/api/revenue/project/${currentProjectId}`);
                if (!response.ok) throw new Error('åŠ è½½æ”¶å…¥é¢„æµ‹æ•°æ®å¤±è´¥');

                revenueList = await response.json();
                renderRevenueTable();
                updateRevenueCharts();

            } catch (error) {
                console.error('åŠ è½½æ”¶å…¥é¢„æµ‹æ•°æ®å¤±è´¥:', error);
                revenueList = [];
                renderRevenueTable();
            }
        }

        // æ¸²æŸ“æ”¶å…¥é¢„æµ‹è¡¨æ ¼
        function renderRevenueTable() {
            const tbody = document.getElementById('revenueTableBody');
            if (!tbody) return;

            if (revenueList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #718096;">
                            æš‚æ— æ”¶å…¥é¢„æµ‹æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            let cumulativeRevenue = 0;

            // æŒ‰æœˆä»½å’ŒæœåŠ¡ç±»å‹åˆ†ç»„è®¡ç®—æ€»æ”¶å…¥
            const monthlyRevenue = {};

            revenueList.forEach(item => {
                const expectedRevenue = parseFloat(item.unit_price) * parseInt(item.expected_quantity);
                cumulativeRevenue += expectedRevenue;

                const month = item.forecast_month;
                if (!monthlyRevenue[month]) {
                    monthlyRevenue[month] = 0;
                }
                monthlyRevenue[month] += expectedRevenue;

                html += `
                    <tr>
                        <td>${item.forecast_month}</td>
                        <td>${item.service_type}</td>
                        <td>${parseFloat(item.unit_price).toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${item.expected_quantity}</td>
                        <td>${expectedRevenue.toLocaleString('zh-CN')}å…ƒ</td>
                        <td>${cumulativeRevenue.toLocaleString('zh-CN')}å…ƒ</td>
                        <td>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #4299e1; color: white; margin-right: 5px;" onclick="editRevenue(${item.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm" style="padding: 5px 10px; background: #f56565; color: white;" onclick="deleteRevenue(${item.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // æ›´æ–°æ”¶å…¥å›¾è¡¨
        function updateRevenueCharts() {
            if (!revenueList.length) return;

            // æŒ‰æœˆèšåˆæ•°æ®
            const monthlyData = {};
            const serviceTypeData = {};

            revenueList.forEach(item => {
                const revenue = parseFloat(item.unit_price) * parseInt(item.expected_quantity);
                const month = item.forecast_month;
                const serviceType = item.service_type;

                // æœˆåº¦æ•°æ®
                if (!monthlyData[month]) {
                    monthlyData[month] = 0;
                }
                monthlyData[month] += revenue;

                // æœåŠ¡ç±»å‹æ•°æ®
                if (!serviceTypeData[serviceType]) {
                    serviceTypeData[serviceType] = 0;
                }
                serviceTypeData[serviceType] += revenue;
            });

            // æ›´æ–°æœˆåº¦æ”¶å…¥é¢„æµ‹å›¾è¡¨
            if (revenueChart) {
                revenueChart.data.labels = Object.keys(monthlyData);
                revenueChart.data.datasets[0].data = Object.values(monthlyData);
                revenueChart.update();
            }

            // æ›´æ–°æ”¶å…¥ç±»å‹åˆ†å¸ƒå›¾è¡¨
            if (revenueTypeChart) {
                revenueTypeChart.data.labels = Object.keys(serviceTypeData);
                revenueTypeChart.data.datasets[0].data = Object.values(serviceTypeData);
                revenueTypeChart.update();
            }
        }

        // åŠ è½½æ”¶å…¥æ•°æ®ï¼ˆæ ¹æ®æ—¶é—´èŒƒå›´ï¼‰
        async function loadRevenueData(months) {
            try {
                const response = await fetch(`/api/revenue/project/${currentProjectId}?months=${months}`);
                if (!response.ok) throw new Error('åŠ è½½æ”¶å…¥æ•°æ®å¤±è´¥');

                revenueList = await response.json();
                renderRevenueTable();
                updateRevenueCharts();

            } catch (error) {
                console.error('åŠ è½½æ”¶å…¥æ•°æ®å¤±è´¥:', error);
                revenueList = [];
                renderRevenueTable();
            }
        }

        // æ˜¾ç¤ºæ”¶å…¥é¢„æµ‹æ¨¡æ€æ¡†
        function showRevenueModal() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // é‡ç½®è¡¨å•
            document.getElementById('revenueForm').reset();
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('revenueForecastMonth').value = `${year}-${month}`;

            showModal('revenueModal');
        }

        // ä¿å­˜æ”¶å…¥é¢„æµ‹
        async function saveRevenue(event) {
            event.preventDefault();

            const formData = {
                project_id: currentProjectId,
                forecast_month: document.getElementById('revenueForecastMonth').value,
                service_type: document.getElementById('revenueForecastType').value,
                unit_price: parseFloat(document.getElementById('revenueUnitPrice').value),
                expected_quantity: parseInt(document.getElementById('revenueExpectedQuantity').value),
                notes: document.getElementById('revenueNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/revenue/project/${currentProjectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('ä¿å­˜æ”¶å…¥é¢„æµ‹å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('æ”¶å…¥é¢„æµ‹ä¿å­˜æˆåŠŸ', 'success');
                    hideModal('revenueModal');
                    await loadRevenue();
                } else {
                    throw new Error(result.error || 'ä¿å­˜æ”¶å…¥é¢„æµ‹å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜æ”¶å…¥é¢„æµ‹å¤±è´¥:', error);
                showMessage('ä¿å­˜æ”¶å…¥é¢„æµ‹å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ç¼–è¾‘æ”¶å…¥é¢„æµ‹
        function editRevenue(revenueId) {
            const item = revenueList.find(r => r.id == revenueId);
            if (item) {
                // å¡«å……è¡¨å•
                document.getElementById('revenueForecastMonth').value = item.forecast_month;
                document.getElementById('revenueForecastType').value = item.service_type;
                document.getElementById('revenueUnitPrice').value = item.unit_price;
                document.getElementById('revenueExpectedQuantity').value = item.expected_quantity;
                document.getElementById('revenueNotes').value = item.notes || '';

                // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’Œè¡¨å•è¡Œä¸º
                document.querySelector('#revenueModal .modal-header').textContent = 'ç¼–è¾‘æ”¶å…¥é¢„æµ‹';
                const form = document.getElementById('revenueForm');
                form.onsubmit = async function(event) {
                    event.preventDefault();
                    await updateRevenue(revenueId, event);
                };

                showModal('revenueModal');
            }
        }

        async function updateRevenue(revenueId, event) {
            event.preventDefault();

            const formData = {
                forecast_month: document.getElementById('revenueForecastMonth').value,
                service_type: document.getElementById('revenueForecastType').value,
                unit_price: parseFloat(document.getElementById('revenueUnitPrice').value),
                expected_quantity: parseInt(document.getElementById('revenueExpectedQuantity').value),
                notes: document.getElementById('revenueNotes').value
            };

            showLoading();
            try {
                const response = await fetch(`/api/revenue/${revenueId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('æ›´æ–°æ”¶å…¥é¢„æµ‹å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('æ”¶å…¥é¢„æµ‹æ›´æ–°æˆåŠŸ', 'success');
                    hideModal('revenueModal');
                    await loadRevenue();
                } else {
                    throw new Error(result.error || 'æ›´æ–°æ”¶å…¥é¢„æµ‹å¤±è´¥');
                }

            } catch (error) {
                console.error('æ›´æ–°æ”¶å…¥é¢„æµ‹å¤±è´¥:', error);
                showMessage('æ›´æ–°æ”¶å…¥é¢„æµ‹å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤æ”¶å…¥é¢„æµ‹
        async function deleteRevenue(revenueId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶å…¥é¢„æµ‹å—ï¼Ÿ')) return;

            showLoading();
            try {
                const response = await fetch(`/api/revenue/${revenueId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('åˆ é™¤æ”¶å…¥é¢„æµ‹å¤±è´¥');

                const result = await response.json();
                if (result.success) {
                    showMessage('æ”¶å…¥é¢„æµ‹åˆ é™¤æˆåŠŸ', 'success');
                    await loadRevenue();
                } else {
                    throw new Error(result.error || 'åˆ é™¤æ”¶å…¥é¢„æµ‹å¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ é™¤æ”¶å…¥é¢„æµ‹å¤±è´¥:', error);
                showMessage('åˆ é™¤æ”¶å…¥é¢„æµ‹å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æˆæœ¬åˆ†å¸ƒå›¾
            const costCtx = document.getElementById('costDistributionChart');
            if (costCtx) {
                costChart = new Chart(costCtx, {
                    type: 'pie',
                    data: {
                        labels: ['è®¾å¤‡', 'è£…ä¿®', 'ç‰©æ–™', 'äººå·¥', 'ç§Ÿé‡‘', 'æ°´ç”µ', 'å…¶ä»–'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#667eea',
                                '#48bb78',
                                '#ed8936',
                                '#f56565',
                                '#4299e1',
                                '#9f7aea',
                                '#718096'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            // é¡¹ç›®è¿›åº¦å›¾
            const progressCtx = document.getElementById('projectProgressChart');
            if (progressCtx) {
                progressChart = new Chart(progressCtx, {
                    type: 'bar',
                    data: {
                        labels: ['è®¾å¤‡', 'è£…ä¿®', 'ç‰©æ–™', 'é¢„ç®—', 'æˆ¿é—´', 'æ”¶å…¥'],
                        datasets: [{
                            label: 'å®Œæˆåº¦ (%)',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // æœˆåº¦æ”¶å…¥é¢„æµ‹å›¾
            const revenueCtx = document.getElementById('revenueForecastChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'æ”¶å…¥é¢„æµ‹ (å…ƒ)',
                            data: [],
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'æ”¶å…¥: ' + context.parsed.y.toLocaleString('zh-CN') + 'å…ƒ';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('zh-CN') + 'å…ƒ';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // æ”¶å…¥ç±»å‹åˆ†å¸ƒå›¾
            const revenueTypeCtx = document.getElementById('revenueTypeChart');
            if (revenueTypeCtx) {
                revenueTypeChart = new Chart(revenueTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea',
                                '#48bb78',
                                '#ed8936',
                                '#f56565',
                                '#4299e1',
                                '#9f7aea'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateCharts() {
            // æ›´æ–°æˆæœ¬åˆ†å¸ƒå›¾
            if (costChart) {
                const equipmentTotal = equipmentList.reduce((sum, eq) => sum + parseFloat(eq.total_price), 0);
                const decorationTotal = decorationList.reduce((sum, item) => sum + parseFloat(item.total_price), 0);
                const inventoryTotal = inventoryList.reduce((sum, item) =>
                    sum + (parseFloat(item.stock_quantity) * parseFloat(item.unit_price)), 0);
                const budgetTotal = budgetList.reduce((sum, item) => sum + parseFloat(item.budget_amount), 0);

                // å‡è®¾å…¶ä»–æˆæœ¬åˆ†å¸ƒ
                const laborTotal = budgetList.filter(b => b.category === 'äººå·¥')
                    .reduce((sum, item) => sum + parseFloat(item.budget_amount), 0);
                const rentTotal = budgetList.filter(b => b.category === 'ç§Ÿé‡‘')
                    .reduce((sum, item) => sum + parseFloat(item.budget_amount), 0);
                const utilityTotal = budgetList.filter(b => b.category === 'æ°´ç”µ')
                    .reduce((sum, item) => sum + parseFloat(item.budget_amount), 0);
                const otherTotal = budgetTotal - equipmentTotal - decorationTotal - inventoryTotal - laborTotal - rentTotal - utilityTotal;

                costChart.data.datasets[0].data = [
                    equipmentTotal, decorationTotal, inventoryTotal,
                    laborTotal, rentTotal, utilityTotal, Math.max(otherTotal, 0)
                ];
                costChart.update();
            }

            // æ›´æ–°é¡¹ç›®è¿›åº¦å›¾
            if (progressChart) {
                // è®¡ç®—å„é¡¹å®Œæˆåº¦ï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
                const equipmentProgress = equipmentList.length > 0 ? 80 : 0;
                const decorationProgress = decorationList.length > 0 ? 60 : 0;
                const inventoryProgress = inventoryList.length > 0 ? 90 : 0;
                const budgetProgress = budgetList.length > 0 ? 70 : 0;
                const roomsProgress = roomList.length > 0 ? 85 : 0;
                const revenueProgress = revenueList.length > 0 ? 50 : 0;

                progressChart.data.datasets[0].data = [
                    equipmentProgress, decorationProgress, inventoryProgress,
                    budgetProgress, roomsProgress, revenueProgress
                ];
                progressChart.update();
            }
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard() {
            const equipmentTotal = equipmentList.reduce((sum, eq) => sum + parseFloat(eq.total_price), 0);
            const decorationTotal = decorationList.reduce((sum, item) => sum + parseFloat(item.total_price), 0);
            const inventoryTotal = inventoryList.reduce((sum, item) =>
                sum + (parseFloat(item.stock_quantity) * parseFloat(item.unit_price)), 0);
            const budgetTotal = budgetList.reduce((sum, item) => sum + parseFloat(item.budget_amount), 0);

            document.getElementById('totalEquipmentValue').textContent = equipmentTotal.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('totalDecorationBudget').textContent = decorationTotal.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('totalInventoryValue').textContent = inventoryTotal.toLocaleString('zh-CN') + 'å…ƒ';
            document.getElementById('totalCostBudget').textContent = budgetTotal.toLocaleString('zh-CN') + 'å…ƒ';

            document.getElementById('equipmentStatus').textContent = `${equipmentList.length}å°è®¾å¤‡`;
            document.getElementById('decorationStatus').textContent = `${decorationList.length}é¡¹è£…ä¿®`;
            document.getElementById('inventoryStatus').textContent = `${inventoryList.length}ç§ç‰©æ–™`;
            document.getElementById('budgetStatus').textContent = `${budgetList.length}é¡¹é¢„ç®—`;
        }

        // æ›´æ–°é¡¹ç›®çŠ¶æ€æ˜¾ç¤º
        function updateProjectStatus() {
            if (!currentProjectData) return;

            const statusElement = document.getElementById('projectStatus');
            const progressElement = document.getElementById('projectProgress');

            const status = getProjectStatus(currentProjectData);
            const totalInvestment = currentProjectData.total_investment || 0;
            const investmentTarget = currentProjectData.investment_target || 0;

            // æ›´æ–°çŠ¶æ€æ ‡ç­¾
            statusElement.textContent = status;
            statusElement.className = `project-status status-${getStatusClass(status)}`;

            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            if (investmentTarget > 0) {
                const progressPercent = Math.min(Math.round((totalInvestment / investmentTarget) * 100), 100);
                progressElement.textContent = `æŠ•èµ„è¿›åº¦: ${progressPercent}% (${totalInvestment.toLocaleString('zh-CN')}å…ƒ / ${investmentTarget.toLocaleString('zh-CN')}å…ƒ)`;
            } else {
                progressElement.textContent = `æ€»æŠ•èµ„: ${totalInvestment.toLocaleString('zh-CN')}å…ƒ`;
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'è§„åˆ’ä¸­': return 'planning';
                case 'ç­¹å¤‡ä¸­': return 'setting';
                case 'è¿è¥ä¸­': return 'operating';
                default: return 'planning';
            }
        }

        // å¯¼å‡ºæŠ¥å‘Š
        async function exportReport() {
            if (!currentProjectId) {
                showMessage('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/report/export/${currentProjectId}`);
                if (!response.ok) throw new Error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `è¶³æµ´åº—é¡¹ç›®æŠ¥å‘Š_${currentProjectData.name}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showMessage('æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', error);
                showMessage('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
                const escHandler = function(event) {
                    if (event.key === 'Escape') {
                        hideModal(modalId);
                    }
                };
                modal._escHandler = escHandler;
                document.addEventListener('keydown', escHandler);
            }
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // ç§»é™¤ESCé”®ç›‘å¬
                if (modal._escHandler) {
                    document.removeEventListener('keydown', modal._escHandler);
                    delete modal._escHandler;
                }
            }
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.style.display = 'flex';
            }
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ¶ˆæ¯æç¤ºå…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            switch(type) {
                case 'success':
                    messageDiv.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                    break;
                case 'error':
                    messageDiv.style.background = 'linear-gradient(135deg, #f56565, #e53e3e)';
                    break;
                case 'warning':
                    messageDiv.style.background = 'linear-gradient(135deg, #ed8936, #dd6b20)';
                    break;
                default:
                    messageDiv.style.background = 'linear-gradient(135deg, #4299e1, #3182ce)';
            }

            document.body.appendChild(messageDiv);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.querySelector('#messageAnimations')) {
                const style = document.createElement('style');
                style.id = 'messageAnimations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // é˜²æ­¢è¡¨å•æäº¤é¡µé¢åˆ·æ–°
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
            });
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideModal(modal.id);
                }
            });
        });
    </script>
</body>
</html>

